
<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Report Dashboard</title>
    
    <!-- CDN Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        .file-input-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        input[type="file"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }
        
        button {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 4px solid #c33;
        }
        
        .category-card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            page-break-inside: avoid;
        }
        
        .category-title {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #3498db;
        }
        
        .variable-block {
            margin-bottom: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            page-break-inside: avoid;
        }
        
        .variable-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }
        
        .variable-name {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            flex: 1;
        }
        
        .variable-meta {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .tag {
            background: #e8f4f8;
            color: #2980b9;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .unit {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .checkbox-label input {
            cursor: pointer;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        th {
            background: #34495e;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .delta-positive {
            color: #27ae60;
            font-weight: 600;
        }
        
        .delta-negative {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .null-value {
            color: #95a5a6;
            font-style: italic;
        }
        
        .subvariable-block {
            margin-left: 20px;
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #95a5a6;
        }
        
        .subvariable-name {
            font-size: 15px;
            font-weight: 600;
            color: #34495e;
            margin-bottom: 10px;
        }
        
        .notes-box {
            margin-top: 20px;
            padding: 15px;
            background: #fff9e6;
            border-left: 4px solid #f39c12;
            border-radius: 4px;
        }
        
        .notes-title {
            font-weight: 600;
            color: #d68910;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .notes-content {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 4px;
            max-width: 800px;
        }
        
        canvas {
            max-height: 300px !important;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        @media print {
            body {
                background: white;
            }
            
            .category-card, .variable-block {
                page-break-inside: avoid;
            }
            
            button, input[type="file"] {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Analytics Report Dashboard</h1>
            <div class="file-input-group">
                <input type="file" id="fileInput" accept="application/json">
                <button id="exportBtn" disabled>Export naar PDF</button>
            </div>
            <div id="errorMsg"></div>
        </header>
        
        <div id="reportContent"></div>
    </div>

    <script>
        // Global data store
        let jsonData = null;
        let chartInstances = [];
        
        // File input handler
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    jsonData = JSON.parse(event.target.result);
                    renderReport(jsonData);
                    document.getElementById('exportBtn').disabled = false;
                    document.getElementById('errorMsg').innerHTML = '';
                } catch (err) {
                    showError('Ongeldige JSON: ' + err.message);
                }
            };
            reader.readAsText(file);
        });
        
        // Export button handler
        document.getElementById('exportBtn').addEventListener('click', () => {
            exportToPDF();
        });
        
        // Show error message
        function showError(msg) {
            document.getElementById('errorMsg').innerHTML = `<div class="error">${msg}</div>`;
            document.getElementById('reportContent').innerHTML = '';
            document.getElementById('exportBtn').disabled = true;
        }
        
        // Trim whitespace from variable names
        function trimName(name) {
            return name.replace(/\s+/g, ' ').trim();
        }
        
        // Calculate delta between current and previous non-null value
        function calculateDelta(data, weeks, currentIndex) {
            if (currentIndex === 0) return null;
            
            const currentValue = data[weeks[currentIndex]];
            if (currentValue === null) return null;
            
            // Find previous non-null value
            for (let i = currentIndex - 1; i >= 0; i--) {
                const prevValue = data[weeks[i]];
                if (prevValue !== null) {
                    return currentValue - prevValue;
                }
            }
            
            return null; // First non-null value
        }
        
        // Format delta for display
        function formatDelta(delta, unit) {
            if (delta === null) return '';
            const sign = delta >= 0 ? '+' : '';
            const className = delta >= 0 ? 'delta-positive' : 'delta-negative';
            return `<span class="${className}">${sign}${delta}${unit}</span>`;
        }
        
        // Natural sort for week labels
        function sortWeeks(weeks) {
            return weeks.sort((a, b) => {
                const numA = parseInt(a.match(/\d+/)?.[0] || '0');
                const numB = parseInt(b.match(/\d+/)?.[0] || '0');
                return numA - numB;
            });
        }
        
        // Render data table
        function renderTable(data, unit) {
            const weeks = sortWeeks(Object.keys(data));
            
            let html = '<table><thead><tr><th>Week</th><th>Waarde</th><th>Delta</th></tr></thead><tbody>';
            
            weeks.forEach((week, index) => {
                const value = data[week];
                const delta = calculateDelta(data, weeks, index);
                
                html += '<tr>';
                html += `<td>${week}</td>`;
                html += `<td>${value !== null ? value + unit : '<span class="null-value">‚Äì</span>'}</td>`;
                html += `<td>${formatDelta(delta, unit)}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }
        
        // Create chart for variable
        function createChart(canvasId, variable, categoryName) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            const weeks = sortWeeks(Object.keys(variable.data));
            const datasets = [];
            
            // Main variable dataset
            datasets.push({
                label: trimName(variable.name),
                data: weeks.map(w => variable.data[w]),
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 4
            });
            
            // Subvariables datasets
            const colors = ['#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#34495e'];
            if (variable.subVariables && variable.subVariables.length > 0) {
                variable.subVariables.forEach((subVar, idx) => {
                    datasets.push({
                        label: trimName(subVar.name),
                        data: weeks.map(w => subVar.data[w]),
                        borderColor: colors[idx % colors.length],
                        backgroundColor: colors[idx % colors.length] + '20',
                        tension: 0.3,
                        borderWidth: 2,
                        pointRadius: 3
                    });
                });
            }
            
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: trimName(variable.name)
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
            
            chartInstances.push(chart);
        }
        
        // Render complete report
        function renderReport(data) {
            // Destroy existing charts
            chartInstances.forEach(chart => chart.destroy());
            chartInstances = [];
            
            const content = document.getElementById('reportContent');
            let html = '';
            
            Object.keys(data).forEach(categoryKey => {
                const category = data[categoryKey];
                html += `<div class="category-card" data-category="${categoryKey}">`;
                html += `<h2 class="category-title">${categoryKey}</h2>`;
                
                if (category.variables) {
                    category.variables.forEach((variable, varIdx) => {
                        const varId = `${categoryKey}-${varIdx}`;
                        const cleanName = trimName(variable.name);
                        const unit = variable.unit || '';
                        
                        html += `<div class="variable-block" data-variable="${varId}">`;
                        html += `<div class="variable-header">`;
                        html += `<div class="variable-name">${cleanName}</div>`;
                        html += `<div class="variable-meta">`;
                        
                        if (variable.tags && variable.tags.length > 0) {
                            variable.tags.forEach(tag => {
                                html += `<span class="tag">${tag}</span>`;
                            });
                        }
                        
                        if (unit) {
                            html += `<span class="unit">(${unit})</span>`;
                        }
                        
                        html += `<label class="checkbox-label">`;
                        html += `<input type="checkbox" class="pdf-select" data-var="${varId}" checked> PDF`;
                        html += `</label>`;
                        html += `</div></div>`;
                        
                        // Main variable table
                        html += renderTable(variable.data, unit);
                        
                        // Chart
                        const chartId = `chart-${varId}`;
                        html += `<div class="chart-container"><canvas id="${chartId}"></canvas></div>`;
                        
                        // Subvariables
                        if (variable.subVariables && variable.subVariables.length > 0) {
                            variable.subVariables.forEach((subVar, subIdx) => {
                                const subId = `${varId}-sub${subIdx}`;
                                html += `<div class="subvariable-block" data-subvar="${subId}">`;
                                html += `<div class="variable-header">`;
                                html += `<div class="subvariable-name">${trimName(subVar.name)}</div>`;
                                html += `<label class="checkbox-label">`;
                                html += `<input type="checkbox" class="pdf-select" data-subvar="${subId}" checked> PDF`;
                                html += `</label>`;
                                html += `</div>`;
                                html += renderTable(subVar.data, unit);
                                html += `</div>`;
                            });
                        }
                        
                        // Notes
                        if (variable.notes && variable.notes.trim()) {
                            html += `<div class="notes-box" data-notes="${varId}">`;
                            html += `<div class="notes-title">üìù Opmerkingen</div>`;
                            html += `<div class="notes-content">${variable.notes}</div>`;
                            html += `</div>`;
                        }
                        
                        html += `</div>`;
                    });
                }
                
                html += `</div>`;
            });
            
            content.innerHTML = html;
            
            // Create charts after DOM update
            setTimeout(() => {
                Object.keys(data).forEach(categoryKey => {
                    const category = data[categoryKey];
                    if (category.variables) {
                        category.variables.forEach((variable, varIdx) => {
                            const varId = `${categoryKey}-${varIdx}`;
                            const chartId = `chart-${varId}`;
                            createChart(chartId, variable, categoryKey);
                        });
                    }
                });
            }, 100);
        }
        
        // Export to PDF
        async function exportToPDF() {
            const btn = document.getElementById('exportBtn');
            btn.disabled = true;
            btn.textContent = 'PDF genereren...';
            
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('landscape', 'mm', 'a4');
                let firstPage = true;
                
                // Get all variable blocks that should be in PDF
                const blocks = document.querySelectorAll('.variable-block');
                
                for (const block of blocks) {
                    const varId = block.dataset.variable;
                    const checkbox = block.querySelector(`input[data-var="${varId}"]`);
                    
                    if (!checkbox || !checkbox.checked) continue;
                    
                    // Clone and prepare element for capture
                    const clone = block.cloneNode(true);
                    
                    // Remove unchecked subvariables
                    const subVars = clone.querySelectorAll('.subvariable-block');
                    subVars.forEach(subVar => {
                        const subId = subVar.dataset.subvar;
                        const subCheckbox = block.querySelector(`input[data-subvar="${subId}"]`);
                        if (!subCheckbox || !subCheckbox.checked) {
                            subVar.remove();
                        }
                    });
                    
                    // Remove checkboxes from clone
                    clone.querySelectorAll('.checkbox-label').forEach(el => el.remove());
                    
                    // Temporarily add to DOM for rendering
                    clone.style.position = 'absolute';
                    clone.style.left = '-9999px';
                    clone.style.width = '1000px';
                    clone.style.background = 'white';
                    document.body.appendChild(clone);
                    
                    // Capture with html2canvas
                    const canvas = await html2canvas(clone, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff'
                    });
                    
                    // Remove clone
                    document.body.removeChild(clone);
                    
                    // Add page if not first
                    if (!firstPage) {
                        pdf.addPage();
                    }
                    firstPage = false;
                    
                    // Add image to PDF
                    const imgData = canvas.toDataURL('image/png');
                    const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    
                    pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth, pdfHeight);
                }
                
                // Save PDF
                pdf.save('analytics-report.pdf');
                
            } catch (err) {
                alert('Fout bij PDF export: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Export naar PDF';
            }
        }
    </script>
</body>
</html>
