<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Report Dashboard</title>
    
    <!-- CDN Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
        color: #333;
        padding: 20px;
        line-height: 1.4;
        font-size: 13px;
    }
    
    .container {
        max-width: 1600px;
        margin: 0 auto;
    }
    
    header {
        background: white;
        padding: 20px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    h1 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 22px;
    }
    
    .file-input-group {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    input[type="file"] {
        padding: 8px;
        border: 2px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        font-size: 13px;
    }
    
    button {
        padding: 8px 16px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: background 0.3s;
    }
    
    button:hover {
        background: #2980b9;
    }
    
    button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
    }
    
    .error {
        background: #fee;
        color: #c33;
        padding: 12px;
        border-radius: 4px;
        margin: 12px 0;
        border-left: 4px solid #c33;
        font-size: 13px;
    }
    
    .category-card {
        background: white;
        padding: 20px;
        border-radius: 6px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        page-break-inside: avoid;
    }
    
    .category-title {
        font-size: 18px;
        color: #2c3e50;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #3498db;
    }
    
    .variable-block {
        margin-bottom: 25px;
        padding: 15px;
        background: #fafbfc;
        border-radius: 4px;
        border-left: 3px solid #3498db;
        page-break-inside: avoid;
    }
    
    .variable-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        gap: 12px;
    }
    
    .variable-name {
        font-size: 15px;
        font-weight: 600;
        color: #2c3e50;
        flex: 1;
    }
    
    .variable-meta {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .pdf-checkbox {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
        color: #7f8c8d;
    }
    
    .pdf-checkbox input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
        margin: 0;
    }
    
    .tag {
        background: #e8f4f8;
        color: #2980b9;
        padding: 3px 10px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 500;
    }
    
    .unit {
        color: #7f8c8d;
        font-size: 12px;
    }
    
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .checkbox-label input {
        cursor: pointer;
        margin: 0;
    }
    
    /* *** AANGEPASTE SECTIE VOOR VERTICALE STAPELING *** */
    .data-container {
        display: flex;
        gap: 15px;
        align-items: flex-start;
        flex-wrap: wrap;
        flex-direction: column; /* Zorgt ervoor dat elementen onder elkaar staan */
        width: 100%; /* Zorgt dat de container de volle breedte inneemt */
    }
    
    .data-section {
        width: 100%; /* Zorgt dat de tabel de volle breedte inneemt */
        margin-bottom: 15px;
    }
    
    .chart-container {
        width: 100%; /* Zorgt dat de grafiek de volle breedte inneemt */
        max-width: none; /* Overschrijft de oude max-width van 600px */
        padding: 10px;
        background: white;
        border-radius: 4px;
    }
    /* *** EINDE AANGEPASTE SECTIE *** */
    
    .data-table-horizontal {
        display: block;
        margin-bottom: 10px;
        overflow-x: auto;
    }
    
    table {
        border-collapse: collapse;
        background: white;
        font-size: 11px;
        width: 100%;
    }
    
    table.horizontal-layout th {
        background: #34495e;
        color: white;
        font-weight: 600;
        font-size: 10px;
        letter-spacing: 0.3px;
        padding: 6px 10px;
        text-align: left;
        border-right: 1px solid #2c3e50;
        white-space: nowrap;
    }
    
    table.horizontal-layout th:first-child {
        min-width: 50px;
        text-align: center;
    }
    
    table.horizontal-layout th:nth-child(2) {
        min-width: 180px;
        max-width: 200px;
    }
    
    table.horizontal-layout th:nth-child(n+3) {
        min-width: 80px;
        max-width: 100px;
        white-space: nowrap;
    }
    
    table.horizontal-layout th:last-child {
        border-right: none;
    }
    
    table.horizontal-layout td {
        padding: 5px 10px;
        text-align: left;
        border-right: 1px solid #ecf0f1;
        border-bottom: 1px solid #ecf0f1;
        white-space: nowrap;
    }
    
    table.horizontal-layout td:first-child {
        text-align: center;
        background: white;
        padding: 3px;
    }
    
    table.horizontal-layout td:nth-child(2) {
        font-weight: 500;
        color: #2c3e50;
        background: #f8f9fa;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    table.horizontal-layout td:nth-child(n+3) {
        min-width: 80px;
        max-width: 100px;
        white-space: nowrap;
    }
    
    table.horizontal-layout td input[type="checkbox"] {
        cursor: pointer;
        width: 16px;
        height: 16px;
        margin: 0;
    }
    
    table.horizontal-layout td:last-child {
        border-right: none;
    }
    
    table.horizontal-layout tr:last-child td {
        border-bottom: none;
    }
    
    table.horizontal-layout .subvar-row td:nth-child(2) {
        padding-left: 20px;
        font-weight: 400;
        color: #555;
    }
    
    tr:hover {
        background: #f8f9fa;
    }
    
    .delta-positive {
        color: #27ae60;
        font-weight: 600;
    }
    
    .delta-negative {
        color: #e74c3c;
        font-weight: 600;
    }
    
    .null-value {
        color: #95a5a6;
        font-style: italic;
    }
    
    .subvariable-block {
        margin-left: 15px;
        margin-top: 12px;
        padding: 10px;
        background: white;
        border-radius: 4px;
        border-left: 2px solid #95a5a6;
        display: none; /* Hidden since subvariables are now in main table */
    }
    
    .subvariable-name {
        font-size: 13px;
        font-weight: 600;
        color: #34495e;
        margin-bottom: 8px;
    }
    
    .notes-box {
        margin-top: 12px;
        padding: 10px;
        background: #fffbf0;
        border-left: 3px solid #f39c12;
        border-radius: 4px;
    }
    
    .notes-title {
        font-weight: 600;
        color: #d68910;
        margin-bottom: 6px;
        font-size: 12px;
    }
    
    .notes-content {
        color: #555;
        font-size: 12px;
        line-height: 1.5;
    }
    
    
    canvas {
        max-height: 250px !important;
    }
    
    .loading {
        text-align: center;
        padding: 15px;
        color: #7f8c8d;
    }
    
    @media print {
        body {
            background: white;
        }
        
        .category-card, .variable-block {
            page-break-inside: avoid;
        }
        
        button, input[type="file"] {
            display: none;
        }
    }
</style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š Analytics Report Dashboard</h1>
            <div class="file-input-group">
                <input type="file" id="fileInput" accept="application/json">
                <button id="exportBtn" disabled>Export naar PDF</button>
            </div>
            <div id="errorMsg"></div>
        </header>
        
        <div id="reportContent"></div>
    </div>

<script>
Â  Â  // Global data store
Â  Â  let jsonData = null;
Â  Â  let chartInstances = [];
Â  Â Â 
Â  Â  // File input handler
Â  Â  document.getElementById('fileInput').addEventListener('change', (e) => {
Â  Â  Â  Â  const file = e.target.files[0];
Â  Â  Â  Â  if (!file) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = (event) => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  jsonData = JSON.parse(event.target.result);
Â  Â  Â  Â  Â  Â  Â  Â  renderReport(jsonData);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('exportBtn').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('errorMsg').innerHTML = '';
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  showError('Ongeldige JSON: ' + err.message);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.readAsText(file);
Â  Â  });
Â  Â Â 
Â  Â  // Export button handler
Â  Â  document.getElementById('exportBtn').addEventListener('click', () => {
Â  Â  Â  Â  exportToPDF();
Â  Â  });
Â  Â Â 
Â  Â  // Show error message
Â  Â  function showError(msg) {
Â  Â  Â  Â  document.getElementById('errorMsg').innerHTML = `<div class="error">${msg}</div>`;
Â  Â  Â  Â  document.getElementById('reportContent').innerHTML = '';
Â  Â  Â  Â  document.getElementById('exportBtn').disabled = true;
Â  Â  }
Â  Â Â 
Â  Â  // Trim whitespace from variable names
Â  Â  function trimName(name) {
Â  Â  Â  Â  return name.replace(/\s+/g, ' ').trim();
Â  Â  }
Â  Â Â 
Â  Â  // Calculate delta between current and previous non-null value
Â  Â  function calculateDelta(data, weeks, currentIndex) {
Â  Â  Â  Â  if (currentIndex === 0) return null;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const currentValue = data[weeks[currentIndex]];
Â  Â  Â  Â  if (currentValue === null) return null;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Find previous non-null value
Â  Â  Â  Â  for (let i = currentIndex - 1; i >= 0; i--) {
Â  Â  Â  Â  Â  Â  const prevValue = data[weeks[i]];
Â  Â  Â  Â  Â  Â  if (prevValue !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  return currentValue - prevValue;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  return null; // First non-null value
Â  Â  }
Â  Â Â 
Â  Â  // Format delta for display
Â  Â  function formatDelta(delta, unit) {
Â  Â  Â  Â  if (delta === null) return '';
Â  Â  Â  Â  const sign = delta >= 0 ? '+' : '';
Â  Â  Â  Â  const className = delta >= 0 ? 'delta-positive' : 'delta-negative';
Â  Â  Â  Â  return `<span class="${className}">${sign}${delta}${unit}</span>`;
Â  Â  }
Â  Â Â 
Â  Â  // Natural sort for week labels
Â  Â  function sortWeeks(weeks) {
Â  Â  Â  Â  return weeks.sort((a, b) => {
Â  Â  Â  Â  Â  Â  const numA = parseInt(a.match(/\d+/)?.[0] || '0');
Â  Â  Â  Â  Â  Â  const numB = parseInt(b.match(/\d+/)?.[0] || '0');
Â  Â  Â  Â  Â  Â  return numA - numB;
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  // Render horizontal data table with main variable and subvariables combined
Â  Â  function renderCombinedTable(variable, unit, varId) {
Â  Â  Â  Â  const weeks = sortWeeks(Object.keys(variable.data));
Â  Â  Â  Â Â 
Â  Â  Â  Â  let html = '<div class="data-table-horizontal"><table class="horizontal-layout">';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Header row with checkbox column + variable name column + week labels
Â  Â  Â  Â  html += '<thead><tr>';
Â  Â  Â  Â  html += '<th>PDF</th>'; // Checkbox column header
Â  Â  Â  Â  html += '<th></th>'; // Empty cell for variable names column
Â  Â  Â  Â  weeks.forEach(week => {
Â  Â  Â  Â  Â  Â  html += `<th>${week}</th>`;
Â  Â  Â  Â  });
Â  Â  Â  Â  html += '</tr></thead><tbody>';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Main variable row
Â  Â  Â  Â  html += '<tr>';
Â  Â  Â  Â  html += `<td><input type="checkbox" class="pdf-select-row" data-var="${varId}" data-type="main" checked></td>`;
Â  Â  Â  Â  html += `<td>${trimName(variable.name)}</td>`;
Â  Â  Â  Â  weeks.forEach((week, index) => {
Â  Â  Â  Â  Â  Â  const value = variable.data[week];
Â  Â  Â  Â  Â  Â  const delta = calculateDelta(variable.data, weeks, index);
Â  Â  Â  Â  Â  Â  let cellContent = value !== null ? value + unit : '<span class="null-value">â€“</span>';
Â  Â  Â  Â  Â  Â  if (delta !== null && delta !== 0) {
Â  Â  Â  Â  Â  Â  Â  Â  cellContent += ' ' + formatDelta(delta, unit);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  html += `<td>${cellContent}</td>`;
Â  Â  Â  Â  });
Â  Â  Â  Â  html += '</tr>';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Subvariables rows
Â  Â  Â  Â  if (variable.subVariables && variable.subVariables.length > 0) {
Â  Â  Â  Â  Â  Â  variable.subVariables.forEach((subVar, subIdx) => {
Â  Â  Â  Â  Â  Â  Â  Â  const subId = `${varId}-sub${subIdx}`;
Â  Â  Â  Â  Â  Â  Â  Â  html += '<tr class="subvar-row">';
Â  Â  Â  Â  Â  Â  Â  Â  html += `<td><input type="checkbox" class="pdf-select-row" data-var="${varId}" data-subvar="${subId}" data-type="sub" checked></td>`;
Â  Â  Â  Â  Â  Â  Â  Â  html += `<td>${trimName(subVar.name)}</td>`;
Â  Â  Â  Â  Â  Â  Â  Â  weeks.forEach((week, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const value = subVar.data[week];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const delta = calculateDelta(subVar.data, weeks, index);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let cellContent = value !== null ? value + unit : '<span class="null-value">â€“</span>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (delta !== null && delta !== 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cellContent += ' ' + formatDelta(delta, unit);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<td>${cellContent}</td>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  html += '</tr>';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  html += '</tbody></table></div>';
Â  Â  Â  Â  return html;
Â  Â  }
Â  Â Â 
Â  Â  // Create chart for variable
Â  Â  function createChart(canvasId, variable, categoryName) {
Â  Â  Â  Â  const ctx = document.getElementById(canvasId);
Â  Â  Â  Â  if (!ctx) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const weeks = sortWeeks(Object.keys(variable.data));
Â  Â  Â  Â  const datasets = [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Main variable dataset
Â  Â  Â  Â  datasets.push({
Â  Â  Â  Â  Â  Â  label: trimName(variable.name),
Â  Â  Â  Â  Â  Â  data: weeks.map(w => variable.data[w]),
Â  Â  Â  Â  Â  Â  borderColor: '#3498db',
Â  Â  Â  Â  Â  Â  backgroundColor: 'rgba(52, 152, 219, 0.1)',
Â  Â  Â  Â  Â  Â  tension: 0.3,
Â  Â  Â  Â  Â  Â  borderWidth: 2,
Â  Â  Â  Â  Â  Â  pointRadius: 3
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Subvariables datasets
Â  Â  Â  Â  const colors = ['#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#34495e'];
Â  Â  Â  Â  if (variable.subVariables && variable.subVariables.length > 0) {
Â  Â  Â  Â  Â  Â  variable.subVariables.forEach((subVar, idx) => {
Â  Â  Â  Â  Â  Â  Â  Â  datasets.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: trimName(subVar.name),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: weeks.map(w => subVar.data[w]),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderColor: colors[idx % colors.length],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: colors[idx % colors.length] + '20',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tension: 0.3,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 2,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pointRadius: 2
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const chart = new Chart(ctx, {
Â  Â  Â  Â  Â  Â  type: 'line',
Â  Â  Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  Â  Â  labels: weeks,
Â  Â  Â  Â  Â  Â  Â  Â  datasets: datasets
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  Â  Â  maintainAspectRatio: true,
Â  Â  Â  Â  Â  Â  Â  Â  aspectRatio: 2,
Â  Â  Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  legend: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  position: 'bottom',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: 10
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  boxWidth: 12,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  padding: 8
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: false
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  beginAtZero: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ticks: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: 10
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Suggested: Add unit to axis label if needed
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ticks: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: 10
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  chartInstances.push(chart);
Â  Â  }
Â  Â Â 
Â  Â  // Render complete report
Â  Â  function renderReport(data) {
Â  Â  Â  Â  // Destroy existing charts
Â  Â  Â  Â  chartInstances.forEach(chart => chart.destroy());
Â  Â  Â  Â  chartInstances = [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  const content = document.getElementById('reportContent');
Â  Â  Â  Â  let html = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  Object.keys(data).forEach(categoryKey => {
Â  Â  Â  Â  Â  Â  const category = data[categoryKey];
Â  Â  Â  Â  Â  Â  html += `<div class="category-card" data-category="${categoryKey}">`;
Â  Â  Â  Â  Â  Â  html += `<h2 class="category-title">${categoryKey}</h2>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (category.variables) {
Â  Â  Â  Â  Â  Â  Â  Â  category.variables.forEach((variable, varIdx) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const varId = `${categoryKey}-${varIdx}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cleanName = trimName(variable.name);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const unit = variable.unit || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="variable-block" data-variable="${varId}">`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="variable-header">`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="variable-name">${cleanName}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="variable-meta">`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (variable.tags && variable.tags.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  variable.tags.forEach(tag => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<span class="tag">${tag}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (unit) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<span class="unit">(${unit})</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `</div></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Combined table with main variable and subvariables
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="data-container">`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="data-section">`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += renderCombinedTable(variable, unit, varId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Chart
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const chartId = `chart-${varId}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="chart-container"><canvas id="${chartId}"></canvas></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `</div>`; // Close data-container
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Notes
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (variable.notes && variable.notes.trim()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="notes-box" data-notes="${varId}">`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="notes-title">ğŸ“ Opmerkingen</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="notes-content">${variable.notes}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  html += `</div>`;
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  content.innerHTML = html;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Create charts after DOM update
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Object.keys(data).forEach(categoryKey => {
Â  Â  Â  Â  Â  Â  Â  Â  const category = data[categoryKey];
Â  Â  Â  Â  Â  Â  Â  Â  if (category.variables) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  category.variables.forEach((variable, varIdx) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const varId = `${categoryKey}-${varIdx}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const chartId = `chart-${varId}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createChart(chartId, variable, categoryKey);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Let charts render fully
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Small delay before PDF is ready to be generated
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('exportBtn').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 500);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }, 100);
Â  Â  }
Â  Â Â 
Â  Â  // Export to PDF with charts and selective rows - OPTIMIZED FOR FILE SIZE
Â  Â  async function exportToPDF() {
Â  Â  Â  Â  const btn = document.getElementById('exportBtn');
Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  btn.textContent = 'PDF genereren...';
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const { jsPDF } = window.jspdf;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Start PDF in 'landscape' (liggend) A4
Â  Â  Â  Â  Â  Â  const pdf = new jsPDF('landscape', 'mm', 'a4');
Â  Â  Â  Â  Â  Â  let firstPage = true;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const blocks = document.querySelectorAll('.variable-block');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  for (const block of blocks) {
Â  Â  Â  Â  Â  Â  Â  Â  const varId = block.dataset.variable;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Check if main variable is selected
Â  Â  Â  Â  Â  Â  Â  Â  const mainCheckbox = block.querySelector(`input[data-var="${varId}"][data-type="main"]`);
Â  Â  Â  Â  Â  Â  Â  Â  if (!mainCheckbox || !mainCheckbox.checked) continue;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Clone and prepare element for capture
Â  Â  Â  Â  Â  Â  Â  Â  const clone = block.cloneNode(true);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Remove checkbox column and unchecked rows from table
Â  Â  Â  Â  Â  Â  Â  Â  const table = clone.querySelector('table');
Â  Â  Â  Â  Â  Â  Â  Â  if (table) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Remove header checkbox column
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const headerRow = table.querySelector('thead tr');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (headerRow) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headerRow.deleteCell(0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Remove checkbox cells from all data rows and remove unchecked rows
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const rows = Array.from(table.querySelectorAll('tbody tr'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rows.forEach((row, idx) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Find the original checkbox status
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalCheckbox = block.querySelectorAll('tbody tr input[type="checkbox"]')[idx];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!originalCheckbox || !originalCheckbox.checked) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.remove();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Remove the checkbox cell
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.deleteCell(0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Clone the chart image data
Â  Â  Â  Â  Â  Â  Â  Â  const originalCanvas = block.querySelector('canvas');
Â  Â  Â  Â  Â  Â  Â  Â  const clonedCanvas = clone.querySelector('canvas');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (originalCanvas && clonedCanvas) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ctx = clonedCanvas.getContext('2d');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clonedCanvas.width = originalCanvas.width;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clonedCanvas.height = originalCanvas.height;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.drawImage(originalCanvas, 0, 0);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Set temporary styles for optimal html2canvas rendering
Â  Â  Â  Â  Â  Â  Â  Â  clone.style.position = 'absolute';
Â  Â  Â  Â  Â  Â  Â  Â  clone.style.left = '-9999px';
Â  Â  Â  Â  Â  Â  Â  Â  clone.style.top = '0';
Â  Â  Â  Â  Â  Â  Â  Â  clone.style.width = '1100px'; // Set width for a good landscape fit
Â  Â  Â  Â  Â  Â  Â  Â  clone.style.padding = '15px';
Â  Â  Â  Â  Â  Â  Â  Â  clone.style.background = '#ffffff'; // Force white background
Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(clone);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, 200));
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Capture with html2canvas - verlaagde schaal voor kleinere bestandsgrootte
Â  Â  Â  Â  Â  Â  Â  Â  const canvas = await html2canvas(clone, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scale: 1.2, // Verlaagd van 1.5 of 2.0 voor kleinere bestanden
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  useCORS: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logging: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: '#ffffff',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowTaint: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  windowWidth: 1100,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  windowHeight: clone.scrollHeight
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Remove clone from DOM
Â  Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(clone);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Add page if not first
Â  Â  Â  Â  Â  Â  Â  Â  if (!firstPage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pdf.addPage();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  firstPage = false;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Convert canvas to JPEG to reduce file size (quality 0.8)
Â  Â  Â  Â  Â  Â  Â  Â  const imgData = canvas.toDataURL('image/jpeg', 0.8);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Calculate optimal size for A4 landscape
Â  Â  Â  Â  Â  Â  Â  Â  const pdfWidth = pdf.internal.pageSize.getWidth() - 20; // 10mm margin each side
Â  Â  Â  Â  Â  Â  Â  Â  const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
Â  Â  Â  Â  Â  Â  Â  Â  const pageHeight = pdf.internal.pageSize.getHeight() - 20;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (pdfHeight <= pageHeight) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Fits nicely, centered
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pdf.addImage(imgData, 'JPEG', 10, 10, pdfWidth, pdfHeight);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Too tall, scale down to fit height
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const scale = pageHeight / pdfHeight;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const scaledWidth = pdfWidth * scale;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const scaledHeight = pageHeight;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pdf.addImage(imgData, 'JPEG', 10, 10, scaledWidth, scaledHeight);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Save PDF
Â  Â  Â  Â  Â  Â  pdf.save('analytics-report-optimized.pdf');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  alert('Fout bij PDF export: ' + err.message);
Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  btn.textContent = 'Export naar PDF';
Â  Â  Â  Â  }
Â  Â  }
Â  Â  </script>
</body>
</html>
