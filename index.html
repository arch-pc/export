<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Report Dashboard</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
        color: #333;
        padding: 20px;
        line-height: 1.4;
        font-size: 13px;
    }

    .container {
        max-width: 1600px;
        margin: 0 auto;
    }

    header {
        background: white;
        padding: 20px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    h1 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 22px;
    }

    .file-input-group {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    input[type="file"] {
        padding: 8px;
        border: 2px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        font-size: 13px;
    }

    button {
        padding: 8px 16px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: background 0.3s;
    }

    button:hover {
        background: #2980b9;
    }

    button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
    }

    .error {
        background: #fee;
        color: #c33;
        padding: 12px;
        border-radius: 4px;
        margin: 12px 0;
        border-left: 4px solid #c33;
        font-size: 13px;
    }

    .category-card {
        background: white;
        padding: 20px;
        border-radius: 6px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        page-break-inside: avoid;
    }

    .category-title {
        font-size: 18px;
        color: #2c3e50;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #3498db;
    }

    .variable-block {
        margin-bottom: 25px;
        padding: 15px;
        background: #fafbfc;
        border-left: 3px solid #3498db;
        border-radius: 4px;
        page-break-inside: avoid;
    }

    .variable-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        gap: 12px;
    }

    .variable-name {
        font-size: 15px;
        font-weight: 600;
        color: #2c3e50;
        flex: 1;
    }

    .variable-meta {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .pdf-checkbox {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
        color: #7f8c8d;
    }

    .pdf-checkbox input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
        margin: 0;
    }

    .tag {
        background: #e8f4f8;
        color: #2980b9;
        padding: 3px 10px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 500;
    }

    .unit {
        color: #7f8c8d;
        font-size: 12px;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        font-size: 12px;
    }

    .checkbox-label input {
        cursor: pointer;
        margin: 0;
    }

    .data-container {
        display: flex;
        gap: 15px;
        align-items: flex-start;
        flex-wrap: wrap;
        flex-direction: column; 
        width: 100%; 
    }

    .data-section {
        width: 100%; 
        margin-bottom: 15px;
    }

    .chart-container {
        width: 100%; 
        max-width: none; 
        padding: 10px;
        background: white;
        border-radius: 4px;
    }

    .data-table-horizontal {
        display: block;
        margin-bottom: 10px;
        overflow-x: auto;
    }

    table {
        border-collapse: collapse;
        background: white;
        font-size: 11px;
        width: 100%; 
        table-layout: fixed;
    }

    table.horizontal-layout th {
        background: #34495e;
        color: white;
        font-weight: 600;
        font-size: 10px;
        letter-spacing: 0.3px;
        padding: 6px 10px;
        text-align: center;
        border-right: 1px solid #2c3e50;
        white-space: normal;
        overflow: hidden;
    }

    table.horizontal-layout th:first-child {
        width: 5%;
        min-width: 50px;
        text-align: center;
    }

    table.horizontal-layout th:nth-child(2) {
        width: 25%;
        min-width: 200px; 
        max-width: 350px;
        text-align: left;
        white-space: normal;
    }

    table.horizontal-layout th:nth-child(n+3) {
        width: auto;
        min-width: 80px; 
        text-align: right;
        white-space: nowrap; 
    }

    table.horizontal-layout th:last-child {
        border-right: none;
    }

    table.horizontal-layout td {
        padding: 5px 10px;
        text-align: right;
        border-right: 1px solid #ecf0f1;
        border-bottom: 1px solid #ecf0f1;
        white-space: nowrap;
        overflow: visible;
    }

    table.horizontal-layout td:first-child {
        text-align: center;
        background: white;
        padding: 3px;
        width: 5%;
    }

    table.horizontal-layout td:nth-child(2) {
        font-weight: 500;
        color: #2c3e50;
        background: #f8f9fa;
        width: 25%;
        max-width: 350px;
        text-align: left;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    table.horizontal-layout td:nth-child(n+3) {
        width: auto;
        min-width: 80px;
        white-space: nowrap;
        text-align: right;
    }
    
    table.horizontal-layout td input[type="checkbox"] {
        cursor: pointer;
        width: 16px;
        height: 16px;
        margin: 0;
    }

    table.horizontal-layout td:last-child {
        border-right: none;
    }

    table.horizontal-layout tr:last-child td {
        border-bottom: none;
    }

    table.horizontal-layout .subvar-row td:nth-child(2) {
        padding-left: 20px;
        font-weight: 400;
        color: #555;
    }

    tr:hover {
        background: #f8f9fa;
    }

    .delta-positive {
        color: #27ae60;
        font-weight: 600;
    }

    .delta-negative {
        color: #e74c3c;
        font-weight: 600;
    }

    .null-value {
        color: #95a5a6;
        font-style: italic;
    }
    
    .notes-box {
        margin-top: 12px;
        padding: 10px;
        background: #fffbf0;
        border-left: 3px solid #f39c12;
        border-radius: 4px;
    }

    .notes-title {
        font-weight: 600;
        color: #d68910;
        margin-bottom: 6px;
        font-size: 12px;
    }

    .notes-content {
        color: #555;
        font-size: 12px;
        line-height: 1.5;
    }

    canvas {
        max-height: 250px !important;
    }

    .loading {
        text-align: center;
        padding: 15px;
        color: #7f8c8d;
    }

    .cover-form {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
    }

    .cover-form h3 {
        font-size: 16px;
        margin-bottom: 12px;
        color: #2c3e50;
    }

    .cover-form label {
        display: block;
        font-size: 13px;
        margin-bottom: 4px;
        font-weight: 500;
        color: #2c3e50;
    }

    .cover-form input[type="text"],
    .cover-form input[type="date"],
    .cover-form textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .cover-form textarea {
        resize: vertical;
    }

    .cover-form > div {
        margin-bottom: 10px;
    }

    @media print {
        body {
            background: white;
        }

        .category-card, .variable-block {
            page-break-inside: avoid;
        }

        button, input[type="file"], .cover-form {
            display: none;
        }
    }
</style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Analytics Report Dashboard</h1>
            <div class="file-input-group">
                <input type="file" id="fileInput" accept="application/json">
                <button id="exportBtn" disabled>Export naar PDF</button>
            </div>
            <div id="errorMsg"></div>
            
            <div class="cover-form">
                <h3>Voorblad instellingen</h3>
                <div>
                    <label>Titel:</label>
                    <input type="text" id="coverTitle" placeholder="bijv. Rapportage REFORMER Studios">
                </div>
<div>
    <label>Rapportageperiode:</label>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="date" id="coverDateFrom" style="flex: 1;">
        <span style="color: #7f8c8d;">tot</span>
        <input type="date" id="coverDateTo" style="flex: 1;">
    </div>
</div>
                <div>
                    <label>Opmerkingen:</label>
                    <textarea id="coverNotes" rows="4" placeholder="Voer hier je opmerkingen in..."></textarea>
                </div>
            </div>
        </header>
        
        <div id="reportContent"></div>
    </div>

<script>
    // Global data store
    let jsonData = null;
    let chartInstances = [];
  
// Zet huidige datum als default
window.addEventListener('DOMContentLoaded', () => {
    const today = new Date();
    document.getElementById('coverDateTo').valueAsDate = today;
    
    // Zet 'van' datum op 1 week geleden
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    document.getElementById('coverDateFrom').valueAsDate = weekAgo;
});
  
    // File input handler
    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
      
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                jsonData = JSON.parse(event.target.result);
                renderReport(jsonData);
                document.getElementById('exportBtn').disabled = false;
                document.getElementById('errorMsg').innerHTML = '';
            } catch (err) {
                showError('Ongeldige JSON: ' + err.message);
            }
        };
        reader.readAsText(file);
    });
  
    // Export button handler
    document.getElementById('exportBtn').addEventListener('click', () => {
        exportToPDF();
    });
  
    // Show error message
    function showError(msg) {
        document.getElementById('errorMsg').innerHTML = `<div class="error">${msg}</div>`;
        document.getElementById('reportContent').innerHTML = '';
        document.getElementById('exportBtn').disabled = true;
    }
  
    // Trim whitespace from variable names
    function trimName(name) {
        return name.replace(/\s+/g, ' ').trim();
    }
  
    // Calculate delta between current and previous non-null value
    function calculateDelta(data, weeks, currentIndex) {
        if (currentIndex === 0) return null;
      
        const currentValue = data[weeks[currentIndex]];
        if (currentValue === null) return null;
      
        // Find previous non-null value
        for (let i = currentIndex - 1; i >= 0; i--) {
            const prevValue = data[weeks[i]];
            if (prevValue !== null) {
                return currentValue - prevValue;
            }
        }
      
        return null;
    }
  
    // Format delta for display
    function formatDelta(delta, unit) {
        if (delta === null) return '';
        const sign = delta >= 0 ? '+' : '';
        const className = delta >= 0 ? 'delta-positive' : 'delta-negative';
        return `<span class="${className}">${sign}${delta}${unit}</span>`;
    }
  
    // Natural sort for week labels
    function sortWeeks(weeks) {
        const sorted = weeks.sort((a, b) => {
            const numA = parseInt(a.match(/\d+/)?.[0] || '0');
            const numB = parseInt(b.match(/\d+/)?.[0] || '0');
            return numA - numB;
        });
      
        return sorted.filter(week => !week.toLowerCase().includes('week 5'));
    }
  
    // Render horizontal data table with main variable and subvariables combined
    function renderCombinedTable(variable, unit, varId) {
        const weeks = sortWeeks(Object.keys(variable.data));
      
        let html = '<div class="data-table-horizontal"><table class="horizontal-layout">';
      
        html += '<thead><tr>';
        html += '<th>PDF</th>';
        html += '<th>Variabele Naam</th>';
        weeks.forEach(week => {
            html += `<th>${week}</th>`;
        });
        html += '</tr></thead><tbody>';
      
        html += '<tr>';
        html += `<td><input type="checkbox" class="pdf-select-row" data-var="${varId}" data-type="main" checked></td>`;
        html += `<td>${trimName(variable.name)}</td>`;
        weeks.forEach((week, index) => {
            const value = variable.data[week];
            const delta = calculateDelta(variable.data, weeks, index);
            let cellContent = value !== null ? value + unit : '<span class="null-value">‚Äî</span>';
            if (delta !== null && delta !== 0) {
                cellContent += ' ' + formatDelta(delta, unit);
            }
            html += `<td>${cellContent}</td>`;
        });
        html += '</tr>';
      
        if (variable.subVariables && variable.subVariables.length > 0) {
            variable.subVariables.forEach((subVar, subIdx) => {
                const subId = `${varId}-sub${subIdx}`;
                html += '<tr class="subvar-row">';
                html += `<td><input type="checkbox" class="pdf-select-row" data-var="${varId}" data-subvar="${subId}" data-type="sub" checked></td>`;
                html += `<td>${trimName(subVar.name)}</td>`;
                weeks.forEach((week, index) => {
                    const value = subVar.data[week];
                    const delta = calculateDelta(subVar.data, weeks, index);
                    let cellContent = value !== null ? value + unit : '<span class="null-value">‚Äî</span>';
                    if (delta !== null && delta !== 0) {
                        cellContent += ' ' + formatDelta(delta, unit);
                    }
                    html += `<td>${cellContent}</td>`;
                });
                html += '</tr>';
            });
        }
      
        html += '</tbody></table></div>';
        return html;
    }
  
    // Create chart for variable
    function createChart(canvasId, variable, categoryName) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;
      
        const weeks = sortWeeks(Object.keys(variable.data));
      
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: weeks,
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            font: {
                                size: 10
                            },
                            boxWidth: 12,
                            padding: 8
                        }
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    }
                }
            }
        });
      
        chartInstances.push(chart);

        const varId = canvasId.replace('chart-', '');
        updateChart(canvasId, jsonData, varId);
    }

    // Update de grafiek op basis van checkbox selectie
    function updateChart(chartId, data, varId) {
        const chart = chartInstances.find(instance => instance.canvas.id === chartId);
        if (!chart) return;

        let variable = null;
        const [categoryKey, varIdx] = varId.split('-');
        if (data[categoryKey] && data[categoryKey].variables) {
            variable = data[categoryKey].variables[parseInt(varIdx)];
        }
        if (!variable) return;

        const weeks = sortWeeks(Object.keys(variable.data));
        const newDatasets = [];

        const subColors = ['#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#34495e'];

        const mainCheckbox = document.querySelector(`input[data-var="${varId}"][data-type="main"]`);
        if (mainCheckbox && mainCheckbox.checked) {
            newDatasets.push({
                label: trimName(variable.name),
                data: weeks.map(w => variable.data[w]),
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 3
            });
        }

        if (variable.subVariables && variable.subVariables.length > 0) {
            variable.subVariables.forEach((subVar, idx) => {
                const subId = `${varId}-sub${idx}`;
                const subCheckbox = document.querySelector(`input[data-var="${varId}"][data-subvar="${subId}"][data-type="sub"]`);

                if (subCheckbox && subCheckbox.checked) {
                    newDatasets.push({
                        label: trimName(subVar.name),
                        data: weeks.map(w => subVar.data[w]),
                        borderColor: subColors[idx % subColors.length],
                        backgroundColor: subColors[idx % subColors.length] + '20',
                        tension: 0.3,
                        borderWidth: 2,
                        pointRadius: 2
                    });
                }
            });
        }

        chart.data.datasets = newDatasets;
        chart.update();
    }
  
    // Render complete report
    function renderReport(data) {
        chartInstances.forEach(chart => chart.destroy());
        chartInstances = [];
      
        const content = document.getElementById('reportContent');
        let html = '';
      
        Object.keys(data).forEach(categoryKey => {
            const category = data[categoryKey];
            html += `<div class="category-card" data-category="${categoryKey}">`;
            html += `<h2 class="category-title">${categoryKey}</h2>`;
          
            if (category.variables) {
                category.variables.forEach((variable, varIdx) => {
                    const varId = `${categoryKey}-${varIdx}`;
                    const cleanName = trimName(variable.name);
                    const unit = variable.unit || '';
                  
                    html += `<div class="variable-block" data-variable="${varId}">`;
                    html += `<div class="variable-header">`;
                    html += `<div class="variable-name">${cleanName}</div>`;
                    html += `<div class="variable-meta">`;
                  
                    if (variable.tags && variable.tags.length > 0) {
                        variable.tags.forEach(tag => {
                            html += `<span class="tag">${tag}</span>`;
                        });
                    }
                  
                    if (unit) {
                        html += `<span class="unit">(${unit})</span>`;
                    }
                  
                    html += `</div></div>`;
                  
                    html += `<div class="data-container">`;
                    html += `<div class="data-section">`;
                    html += renderCombinedTable(variable, unit, varId);
                    html += `</div>`;
                  
                    const chartId = `chart-${varId}`;
                    html += `<div class="chart-container"><canvas id="${chartId}"></canvas></div>`;
                  
                    html += `</div>`;
                  
                    if (variable.notes && variable.notes.trim()) {
                        html += `<div class="notes-box" data-notes="${varId}">`;
                        html += `<div class="notes-title">üìù Opmerkingen</div>`;
                        html += `<div class="notes-content">${variable.notes}</div>`;
                        html += `</div>`;
                    }
                  
                    html += `</div>`;
                });
            }
          
            html += `</div>`;
        });
      
        content.innerHTML = html;
      
        setTimeout(() => {
            Object.keys(data).forEach(categoryKey => {
                const category = data[categoryKey];
                if (category.variables) {
                    category.variables.forEach((variable, varIdx) => {
                        const varId = `${categoryKey}-${varIdx}`;
                        const chartId = `chart-${varId}`;
                        createChart(chartId, variable, categoryKey);
                    });
                  
                    setTimeout(() => {
                        document.getElementById('exportBtn').disabled = false;
                    }, 500);
                }
            });

            document.querySelectorAll('.pdf-select-row').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const varId = e.target.dataset.var;
                    const chartId = `chart-${varId}`;
                    updateChart(chartId, jsonData, varId);   
                });
            });

        }, 100);
    }
  
    // Export to PDF with cover page
    async function exportToPDF() {
        const btn = document.getElementById('exportBtn');
        btn.disabled = true;
        btn.textContent = 'PDF genereren...';
      
        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('landscape', 'mm', 'a4');
            
            // Voorblad genereren
            const coverTitle = document.getElementById('coverTitle').value || 'Analytics Report';
const coverDateFrom = document.getElementById('coverDateFrom').value || '';
const coverDateTo = document.getElementById('coverDateTo').value || '';

// Formatteer de datums naar Nederlands formaat
const dateFrom = coverDateFrom ? new Date(coverDateFrom).toLocaleDateString('nl-NL') : '';
const dateTo = coverDateTo ? new Date(coverDateTo).toLocaleDateString('nl-NL') : '';
const coverDateRange = (dateFrom && dateTo) ? `${dateFrom} tot ${dateTo}` : 'Geen periode ingesteld';            const coverNotes = document.getElementById('coverNotes').value || '';
            
            // Maak voorblad element
            const coverPage = document.createElement('div');
            coverPage.style.cssText = `
                position: absolute;
                left: -9999px;
                width: 1100px;
                height: 750px;
                background: white;
                padding: 60px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            `;
            
coverPage.innerHTML = `
    <div style="text-align: center;">
        <h1 style="font-size: 48px; color: #2c3e50; margin-bottom: 15px; font-weight: 600;">${coverTitle}</h1>
        <p style="font-size: 14px; color: #7f8c8d; margin-bottom: 40px;">Rapportageperiode: ${coverDateRange}</p>
    </div>
    <div style="background: #fafbfc; border-left: 3px solid #3498db; padding: 15px; border-radius: 4px; min-height: 200px;">
        <h3 style="font-size: 16px; color: #2c3e50; margin-bottom: 10px; font-weight: 600;">OPMERKINGEN</h3>
        <p style="font-size: 13px; color: #555; line-height: 1.6; white-space: pre-wrap;">${coverNotes || 'Geen opmerkingen toegevoegd.'}</p>
    </div>
`;
            
            document.body.appendChild(coverPage);
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // Render voorblad
            const coverCanvas = await html2canvas(coverPage, {
                scale: 1.2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff',
                allowTaint: true,
                windowWidth: 1100,
                windowHeight: 750
            });
            
            document.body.removeChild(coverPage);
            
            // Voeg voorblad toe aan PDF
            const coverImgData = coverCanvas.toDataURL('image/jpeg', 0.8);
            const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
            const pdfHeight = (coverCanvas.height * pdfWidth) / coverCanvas.width;
            pdf.addImage(coverImgData, 'JPEG', 10, 10, pdfWidth, pdfHeight);
            
            // Start met data pagina's
            let firstPage = false;
            const blocks = document.querySelectorAll('.variable-block');
      
            for (const block of blocks) {
                const varId = block.dataset.variable;
              
                const clone = block.cloneNode(true);
              
                const table = clone.querySelector('table');
                if (table) {
                    const headerRow = table.querySelector('thead tr');
                    if (headerRow) {
                        headerRow.deleteCell(0);
                    }
                  
                    const rows = Array.from(table.querySelectorAll('tbody tr'));
                    rows.forEach((row) => {
                        const cellToDelete = row.cells[0]; 
                        if (cellToDelete) {
                            cellToDelete.remove();
                        }
                    });

                    const tableClone = clone.querySelector('table.horizontal-layout');
                    if (tableClone) {
                        const headerCell = tableClone.querySelector('thead tr th:nth-child(1)');
                        if (headerCell) {
                            headerCell.style.width = '180px';
                            headerCell.style.minWidth = '180px';
                            headerCell.style.maxWidth = '180px';
                            headerCell.style.textAlign = 'left';
                        }

                        const dataHeaders = tableClone.querySelectorAll('thead tr th:not(:first-child)');
                        dataHeaders.forEach(header => {
                            header.style.width = '70px';
                            header.style.minWidth = '70px';
                            header.style.textAlign = 'right';
                        });

                        tableClone.querySelectorAll('tbody tr').forEach(row => {
                            const nameCell = row.querySelector('td:nth-child(1)');
                            if (nameCell) {
                                nameCell.style.paddingLeft = row.classList.contains('subvar-row') ? '20px' : '10px';
                                nameCell.style.textAlign = 'left';
                                nameCell.style.width = '180px';
                                nameCell.style.minWidth = '180px';
                                nameCell.style.maxWidth = '180px';
                                nameCell.style.whiteSpace = 'normal';
                            }

                            for (let i = 1; i < row.cells.length; i++) {
                                row.cells[i].style.width = '70px';
                                row.cells[i].style.minWidth = '70px';
                                row.cells[i].style.textAlign = 'right';
                            }
                        });
                    }
                }
              
const originalCanvas = block.querySelector('canvas');
                const clonedCanvas = clone.querySelector('canvas');
              
                if (originalCanvas && clonedCanvas) {
                    const ctx = clonedCanvas.getContext('2d');
                    clonedCanvas.width = originalCanvas.width;
                    clonedCanvas.height = originalCanvas.height;
                    ctx.drawImage(originalCanvas, 0, 0);
                }
              
                clone.style.position = 'absolute';
                clone.style.left = '-9999px';
                clone.style.top = '0';
                clone.style.width = '1100px';
                clone.style.padding = '15px';
                clone.style.background = '#ffffff';
                document.body.appendChild(clone);
              
                await new Promise(resolve => setTimeout(resolve, 200));
              
                const canvas = await html2canvas(clone, {
                    scale: 1.2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    allowTaint: true,
                    windowWidth: 1100,
                    windowHeight: clone.scrollHeight
                });
              
                document.body.removeChild(clone);
              
                if (!firstPage) {
                    pdf.addPage();
                }
                firstPage = false;
              
                const imgData = canvas.toDataURL('image/jpeg', 0.8);
              
                const pageWidth = pdf.internal.pageSize.getWidth() - 20;
                const pageImgHeight = (canvas.height * pageWidth) / canvas.width;
                const pageHeight = pdf.internal.pageSize.getHeight() - 20;
              
                if (pageImgHeight <= pageHeight) {
                    pdf.addImage(imgData, 'JPEG', 10, 10, pageWidth, pageImgHeight);
                } else {
                    const scale = pageHeight / pageImgHeight;
                    const scaledWidth = pageWidth * scale;
                    const scaledHeight = pageHeight;
                    pdf.addImage(imgData, 'JPEG', 10, 10, scaledWidth, scaledHeight);
                }
            }
      
            pdf.save('analytics-report-optimized.pdf');
      
        } catch (err) {
            alert('Fout bij PDF export: ' + err.message);
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Export naar PDF';
        }
    }
</script>
</body>
</html>
