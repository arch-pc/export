<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Export</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* CSS voor de webweergave */
        body {
            background-color: #f8f9fa;
        }
        .container-main {
            padding: 30px;
        }
        .category-container {
            border: 1px solid #dee2e6;
            border-radius: 0.3rem;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #ffffff;
        }
        .variable-card {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-left: 5px solid #0d6efd;
            border-radius: 0.25rem;
            background-color: #f8f9fa;
        }
        .sub-variable-row {
            font-size: 0.9em;
            color: #495057;
            padding-left: 20px;
            border-top: 1px dotted #ced4da;
        }
        .notes {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3cd;
            color: #664d03;
            border-radius: 0.25rem;
            font-style: italic;
            font-size: 0.9em;
        }
        .chart-container {
            max-height: 350px;
            margin-top: 20px;
        }
        /* CSS voor de PDF (Print media query) - Verberg besturingselementen */
        @media print {
            .no-print {
                display: none !important;
            }
            .category-container {
                page-break-inside: avoid;
                margin-bottom: 15px;
            }
        }
        /* Nieuwe stijlen voor PDF-tabel (zorgt voor betere rendering) */
        .pdf-data-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.8em;
            margin-top: 10px;
            border: 1px solid #ddd;
        }
        .pdf-data-table th, .pdf-data-table td {
            border: 1px solid #eee;
            padding: 5px;
            text-align: right;
        }
        .pdf-data-table th {
            background-color: #f1f1f1;
            font-weight: bold;
            text-align: center;
        }
        .pdf-data-table .label-cell {
            text-align: left;
            width: 30%;
        }
        .pdf-data-table .main-row .label-cell {
            font-weight: bold;
            background-color: #f8f8f8;
        }
        .pdf-data-table .sub-row .label-cell {
            font-style: italic;
            padding-left: 15px;
        }
    </style>
</head>
<body>

    <div class="container container-main">
        <h1 class="mb-4">Analyse Dashboard</h1>

        <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 p-3 border rounded no-print bg-white">
            <div class="d-flex align-items-center me-3 mb-2 mb-md-0">
                <label for="jsonUpload" class="form-label mb-0 me-3 fw-bold">1. Upload JSON-bestand:</label>
                <input class="form-control" type="file" id="jsonUpload" accept=".json">
            </div>
            
            <div class="mb-2 mb-md-0">
                <p class="lead mb-0">2. Selecteer variabelen en klik op exporteren.</p>
            </div>
            
            <button id="exportPdfBtn" class="btn btn-primary btn-lg" disabled>
                <i class="bi bi-file-earmark-pdf"></i> Exporteren naar PDF
            </button>
        </div>

        <div id="contentContainer">
            <div class="alert alert-info text-center">
                <i class="bi bi-upload"></i> **Upload uw JSON-bestand** om de analyse te starten.
            </div>
        </div>

    </div>

    <script>
        const allCharts = {};

        // Functie om de JSON te laden vanuit het geüploade bestand
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    generateContent(jsonData);
                    document.getElementById('exportPdfBtn').disabled = false;
                } catch (error) {
                    console.error("Fout bij het parsen van de JSON:", error);
                    document.getElementById('contentContainer').innerHTML = '<div class="alert alert-danger"><strong>Fout:</strong> Ongeldig JSON-formaat. Controleer uw bestand.</div>';
                    document.getElementById('exportPdfBtn').disabled = true;
                }
            };
            reader.readAsText(file);
        }

        // --- HULPFUNCTIES (Data en rendering) ---

        function getWeekLabels(data) {
            const labels = new Set();
            for (const category in data) {
                data[category].variables.forEach(variable => {
                    Object.keys(variable.data).forEach(key => labels.add(key));
                    variable.subVariables.forEach(sub => {
                        Object.keys(sub.data).forEach(key => labels.add(key));
                    });
                });
            }
            return Array.from(labels).sort();
        }

        function getValidData(dataObject) {
            return Object.values(dataObject).filter(value => value !== null);
        }

        function generateDataRows(dataObject, unit) {
            return `
                <div class="row small">
                    ${Object.values(dataObject).map(value => {
                        if (value === null) {
                            return `<div class="col text-muted">n/a</div>`;
                        }
                        return `<div class="col">${value}${unit}</div>`;
                    }).join('')}
                </div>
            `;
        }

        function getSelectedDatasets(chartId) {
            const datasets = [];
            const checkboxes = document.querySelectorAll(`[data-chart-id="${chartId}"]`);
            const colors = ['#0d6efd', '#dc3545', '#ffc107', '#198754', '#6f42c1', '#20c997', '#fd7e14', '#e637a0']; 
            let colorIndex = 0;

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const label = checkbox.getAttribute('data-label');
                    const data = JSON.parse(checkbox.getAttribute('data-data'));
                    
                    if (data.length > 0) {
                         datasets.push({
                            label: label,
                            data: data,
                            borderColor: colors[colorIndex % colors.length],
                            backgroundColor: colors[colorIndex % colors.length] + '40', 
                            tension: 0.1,
                            fill: false
                        });
                        colorIndex++;
                    }
                }
            });
            return datasets;
        }
        
        // --- HOOFD RENDERING FUNCTIES ---

        function generateContent(data) {
            const container = document.getElementById('contentContainer');
            container.innerHTML = ''; 
            
            const weekLabels = getWeekLabels(data);

            Object.values(allCharts).forEach(chart => chart.destroy());
            Object.keys(allCharts).forEach(key => delete allCharts[key]);

            for (const category in data) {
                const categoryData = data[category];
                const categoryName = category.charAt(0) + category.substring(1).toLowerCase();

                let categoryHtml = `
                    <div class="category-container" data-category="${categoryName}">
                        <h2 class="text-primary border-bottom pb-2 mb-3">${categoryName}</h2>
                `;

                categoryData.variables.forEach((variable, varIndex) => {
                    const cleanName = variable.name.trim(); 
                    const variableId = `${categoryName}-${varIndex}`;
                    const chartId = `chart-${variableId}`;

                    const mainData = getValidData(variable.data);
                    const mainDataRows = generateDataRows(variable.data, variable.unit);

                    const subVariableHtml = variable.subVariables.map((sub, subIndex) => {
                        const subVarId = `${variableId}-sub-${subIndex}`;
                        const subDataRows = generateDataRows(sub.data, variable.unit);
                        return `
                            <div class="row sub-variable-row align-items-center" data-label="${sub.name.trim()}" data-data-unit="${variable.unit}" data-data-values='${JSON.stringify(sub.data)}'>
                                <div class="col-1 no-print">
                                    <input type="checkbox" checked class="form-check-input select-item" id="${subVarId}" data-chart-id="${chartId}" data-label="${sub.name.trim()}" data-data='${JSON.stringify(getValidData(sub.data))}' data-type="sub">
                                </div>
                                <div class="col-3 pt-2">
                                    <label class="form-check-label fw-semibold" for="${subVarId}">${sub.name.trim()}</label>
                                </div>
                                <div class="col-8 pt-2">
                                    ${subDataRows}
                                </div>
                            </div>
                        `;
                    }).join('');

                    categoryHtml += `
                        <div class="variable-card" id="card-${variableId}" data-main-data-values='${JSON.stringify(variable.data)}' data-data-unit="${variable.unit}">
                            <div class="row align-items-center">
                                <div class="col-1 no-print">
                                    <input type="checkbox" checked class="form-check-input select-item" id="${variableId}" data-chart-id="${chartId}" data-label="${cleanName}" data-data='${JSON.stringify(mainData)}' data-type="main">
                                </div>
                                <div class="col-3">
                                    <label class="form-check-label h5 mb-0" for="${variableId}">
                                        ${cleanName} ${variable.unit ? `(${variable.unit})` : ''}
                                    </label>
                                </div>
                                <div class="col-8">
                                    <div class="row fw-bold text-muted small border-bottom mb-1 week-labels-row">
                                        ${weekLabels.map(label => `<div class="col">${label}</div>`).join('')}
                                    </div>
                                    ${mainDataRows}
                                </div>
                            </div>

                            ${subVariableHtml}

                            ${variable.notes.trim() ? `<div class="notes">${variable.notes.trim()}</div>` : ''}

                            <div class="chart-container">
                                <canvas id="${chartId}"></canvas>
                            </div>
                        </div>
                    `;
                });

                categoryHtml += `</div>`;
                container.innerHTML += categoryHtml;
            }
            
            initializeCharts(data);
            addEventListeners();
        }

        function initializeCharts(data) {
            const labels = getWeekLabels(data);
            
            document.querySelectorAll('canvas').forEach(canvas => {
                const chartId = canvas.id;
                const datasets = getSelectedDatasets(chartId);

                if (datasets.length > 0) {
                    canvas.style.display = 'block';
                    const ctx = canvas.getContext('2d');
                    allCharts[chartId] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom', // Zet de legenda onderaan voor betere PDF-passendheid
                                    labels: {
                                        boxWidth: 20
                                    }
                                },
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: datasets[0].label.includes('(') ? datasets[0].label.match(/\((.*?)\)/)[1] : ''
                                    }
                                }
                            }
                        }
                    });
                } else {
                    canvas.style.display = 'none';
                }
            });
        }
        
        function addEventListeners() {
            document.querySelectorAll('.select-item').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const chartId = this.getAttribute('data-chart-id');
                    const chart = allCharts[chartId];
                    
                    if (chart) {
                        chart.data.datasets = getSelectedDatasets(chartId);
                        chart.update();
                    }
                });
            });

            document.getElementById('jsonUpload').addEventListener('change', handleFileUpload);
            document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);
        }

        // --- PDF EXPORT FUNCTIE (geoptimaliseerd) ---

        function createPdfTable(variableCard, isMainChecked, weekLabels) {
            const mainCheckbox = variableCard.querySelector('input[data-type="main"]');
            const subCheckboxes = variableCard.querySelectorAll('input[data-type="sub"]');
            
            const mainLabelText = variableCard.querySelector('label.h5').textContent.replace(/\s\(.*?\)/, '');
            const unit = variableCard.getAttribute('data-data-unit');

            // Maak de tabel-header (Week 1, Week 2, etc.)
            let tableHtml = `<table class="pdf-data-table"><thead><tr><th class="label-cell">Variabele</th>`;
            weekLabels.forEach(label => {
                tableHtml += `<th>${label}</th>`;
            });
            tableHtml += `</tr></thead><tbody>`;

            // Hulpmiddel om data rij te maken
            const createRow = (label, dataValues, isMain) => {
                let rowHtml = `<tr class="${isMain ? 'main-row' : 'sub-row'}">`;
                rowHtml += `<td class="label-cell">${label}</td>`;
                weekLabels.forEach(week => {
                    const value = dataValues[week];
                    rowHtml += `<td>${value === null ? 'n/a' : value + unit}</td>`;
                });
                rowHtml += `</tr>`;
                return rowHtml;
            };

            // Hoofdwaarde toevoegen
            if (isMainChecked) {
                const mainData = JSON.parse(variableCard.getAttribute('data-main-data-values'));
                tableHtml += createRow(mainLabelText, mainData, true);
            }

            // Subvariabelen toevoegen
            subCheckboxes.forEach(subCheckbox => {
                if (subCheckbox.checked) {
                    const subRowElement = subCheckbox.closest('.sub-variable-row');
                    const subLabel = subRowElement.getAttribute('data-label');
                    const subData = JSON.parse(subRowElement.getAttribute('data-data-values'));
                    tableHtml += createRow(subLabel, subData, false);
                }
            });
            
            tableHtml += `</tbody></table>`;
            return tableHtml;
        }

        function exportToPdf() {
            document.getElementById('exportPdfBtn').disabled = true;

            const tempDiv = document.createElement('div');
            tempDiv.style.padding = '0.5in'; 
            
            const allWeekLabels = getWeekLabels(JSON.parse(document.getElementById('jsonUpload').files[0].content)); // Haal labels opnieuw op

            document.querySelectorAll('.category-container').forEach(categoryContainer => {
                const categoryName = categoryContainer.querySelector('h2').textContent;
                const tempCategoryContainer = document.createElement('div');
                tempCategoryContainer.style.marginBottom = '20px';
                tempCategoryContainer.style.pageBreakInside = 'avoid'; // Zorgt voor betere paginering

                tempCategoryContainer.innerHTML = `<h3 style="color: #0d6efd; border-bottom: 2px solid #0d6efd; padding-bottom: 5px; margin-bottom: 15px;">${categoryName}</h3>`;
                let hasVisibleVariable = false;

                categoryContainer.querySelectorAll('.variable-card').forEach(variableCard => {
                    const mainCheckbox = variableCard.querySelector('input[data-type="main"]');
                    const subCheckboxes = variableCard.querySelectorAll('input[data-type="sub"]');
                    
                    const isMainChecked = mainCheckbox && mainCheckbox.checked;
                    const isAnySubChecked = Array.from(subCheckboxes).some(cb => cb.checked);

                    if (isMainChecked || isAnySubChecked) {
                        hasVisibleVariable = true;
                        
                        const tempVariableCard = document.createElement('div');
                        tempVariableCard.style.padding = '15px';
                        tempVariableCard.style.border = '1px solid #ccc';
                        tempVariableCard.style.borderLeft = '5px solid #0d6efd';
                        tempVariableCard.style.marginBottom = '15px';
                        tempVariableCard.style.pageBreakInside = 'avoid';

                        const mainLabel = variableCard.querySelector('label.h5').textContent;
                        
                        // 1. Titel
                        tempVariableCard.innerHTML = `<h5 style="color: #333; margin-bottom: 5px;">${mainLabel}</h5>`;
                        
                        // 2. Data Tabel (Geoptimaliseerd voor PDF)
                        tempVariableCard.innerHTML += createPdfTable(variableCard, isMainChecked, allWeekLabels);

                        // 3. Notities
                        const notesElement = variableCard.querySelector('.notes');
                        if (notesElement) {
                            tempVariableCard.innerHTML += `<div style="margin-top: 15px; padding: 8px; background-color: #fcf8e3; border: 1px solid #faebcc; border-radius: 4px; font-size: 0.8em;">**Opmerking:** ${notesElement.textContent.trim()}</div>`;
                        }

                        // 4. Grafiek (Canvas omzetten naar afbeelding)
                        const chartCanvas = variableCard.querySelector('canvas');
                        if (chartCanvas && chartCanvas.style.display !== 'none') {
                            try {
                                const chartImage = chartCanvas.toDataURL('image/png');
                                tempVariableCard.innerHTML += `<img src="${chartImage}" style="width: 100%; max-height: 250px; object-fit: contain; margin-top: 15px; border: 1px solid #ccc;">`;
                            } catch(e) {
                                console.error("Fout bij het converteren van canvas naar afbeelding:", e);
                                tempVariableCard.innerHTML += `<p style="color: red; margin-top: 15px;">Fout bij het laden van de grafiek in de PDF.</p>`;
                            }
                        }
                        
                        tempCategoryContainer.appendChild(tempVariableCard);
                    }
                });

                if (hasVisibleVariable) {
                    tempDiv.appendChild(tempCategoryContainer);
                }
            });

            // Start de PDF-generatie (Liggende oriëntatie)
            const opt = {
                margin: 0.5, 
                filename: 'Analyse_Export.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, scrollY: 0, useCORS: true }, // useCORS: true kan helpen bij canvas export
                jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' } 
            };

            html2pdf().from(tempDiv).set(opt).save(() => {
                document.getElementById('exportPdfBtn').disabled = false;
            });
        }
        
        // --- INITIALISATIE ---
        document.addEventListener('DOMContentLoaded', addEventListeners);
        
        // HACK om de fileReader data beschikbaar te maken voor getWeekLabels in exportToPdf
        // Dit is nodig omdat de data anders niet meer beschikbaar is
        document.getElementById('jsonUpload').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    file.content = e.target.result; // Voeg de inhoud toe aan het bestandsobject
                    handleFileUpload({ target: { files: [file] } });
                };
                reader.readAsText(file);
            }
        });
        
    </script>
</body>
</html>
