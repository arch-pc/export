<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Report Dashboard</title>
    
    <!-- CDN Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
        color: #333;
        padding: 20px;
        line-height: 1.4;
        font-size: 13px;
    }
    
    .container {
        max-width: 1600px;
        margin: 0 auto;
    }
    
    header {
        background: white;
        padding: 20px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    h1 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 22px;
    }
    
    .file-input-group {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    input[type="file"] {
        padding: 8px;
        border: 2px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        font-size: 13px;
    }
    
    button {
        padding: 8px 16px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: background 0.3s;
    }
    
    button:hover {
        background: #2980b9;
    }
    
    button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
    }
    
    .error {
        background: #fee;
        color: #c33;
        padding: 12px;
        border-radius: 4px;
        margin: 12px 0;
        border-left: 4px solid #c33;
        font-size: 13px;
    }
    
    .category-card {
        background: white;
        padding: 20px;
        border-radius: 6px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        page-break-inside: avoid;
    }
    
    .category-title {
        font-size: 18px;
        color: #2c3e50;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #3498db;
    }
    
    .variable-block {
        margin-bottom: 25px;
        padding: 15px;
        background: #fafbfc;
        border-radius: 4px;
        border-left: 3px solid #3498db;
        page-break-inside: avoid;
    }
    
    .variable-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        gap: 12px;
    }
    
    .variable-name {
        font-size: 15px;
        font-weight: 600;
        color: #2c3e50;
        flex: 1;
    }
    
    .variable-meta {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .pdf-checkbox {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
        color: #7f8c8d;
    }
    
    .pdf-checkbox input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
        margin: 0;
    }
    
    .tag {
        background: #e8f4f8;
        color: #2980b9;
        padding: 3px 10px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 500;
    }
    
    .unit {
        color: #7f8c8d;
        font-size: 12px;
    }
    
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .checkbox-label input {
        cursor: pointer;
        margin: 0;
    }
    
    /* *** AANGEPASTE SECTIE VOOR VERTICALE STAPELING *** */
    .data-container {
        display: flex;
        gap: 15px;
        align-items: flex-start;
        flex-wrap: wrap;
        flex-direction: column; /* Zorgt ervoor dat elementen onder elkaar staan */
        width: 100%; /* Zorgt dat de container de volle breedte inneemt */
    }
    
    .data-section {
        width: 100%; /* Zorgt dat de tabel de volle breedte inneemt */
        margin-bottom: 15px;
    }
    
    .chart-container {
        width: 100%; /* Zorgt dat de grafiek de volle breedte inneemt */
        max-width: none; /* Overschrijft de oude max-width van 600px */
        padding: 10px;
        background: white;
        border-radius: 4px;
    }
    /* *** EINDE AANGEPASTE SECTIE *** */
    
    .data-table-horizontal {
        display: block;
        margin-bottom: 10px;
        overflow-x: auto;
    }
    
    table {
        border-collapse: collapse;
        background: white;
        font-size: 11px;
        width: 100%;
    }
    
    /* *** START AANGEPASTE TABEL STIJL VOOR JUISTE UITLIJNING *** */
    table.horizontal-layout th {
        background: #34495e;
        color: white;
        font-weight: 600;
        font-size: 10px;
        letter-spacing: 0.3px;
        padding: 6px 10px;
        text-align: center; /* Standaard tekstuitlijning gecentreerd */
        border-right: 1px solid #2c3e50;
        white-space: nowrap;
    }
    
    table.horizontal-layout th:first-child {
        min-width: 50px;
        text-align: center;
    }
    
    table.horizontal-layout th:nth-child(2) {
        min-width: 180px;
        max-width: 200px;
        text-align: left; /* Naamkolom links uitlijnen */
    }
    
    table.horizontal-layout th:nth-child(n+3) {
        min-width: 80px;
        max-width: 100px;
        white-space: nowrap;
        text-align: right; /* Data kolommen rechts uitlijnen */
    }
    
    table.horizontal-layout th:last-child {
        border-right: none;
    }
    
    table.horizontal-layout td {
        padding: 5px 10px;
        text-align: right; /* Standaard data rechts uitlijnen */
        border-right: 1px solid #ecf0f1;
        border-bottom: 1px solid #ecf0f1;
        white-space: nowrap;
    }
    
    table.horizontal-layout td:first-child {
        text-align: center;
        background: white;
        padding: 3px;
    }
    
    table.horizontal-layout td:nth-child(2) {
        font-weight: 500;
        color: #2c3e50;
        background: #f8f9fa;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: left; /* Naamkolom links uitlijnen */
    }
    
    table.horizontal-layout td:nth-child(n+3) {
        min-width: 80px;
        max-width: 100px;
        white-space: nowrap;
        text-align: right; /* Zorgen dat data rechts uitgelijnd blijft */
    }
    /* *** EINDE AANGEPASTE TABEL STIJL *** */
    
    table.horizontal-layout td input[type="checkbox"] {
        cursor: pointer;
        width: 16px;
        height: 16px;
        margin: 0;
    }
    
    table.horizontal-layout td:last-child {
        border-right: none;
    }
    
    table.horizontal-layout tr:last-child td {
        border-bottom: none;
    }
    
    table.horizontal-layout .subvar-row td:nth-child(2) {
        padding-left: 20px;
        font-weight: 400;
        color: #555;
    }
    
    tr:hover {
        background: #f8f9fa;
    }
    
    .delta-positive {
        color: #27ae60;
        font-weight: 600;
    }
    
    .delta-negative {
        color: #e74c3c;
        font-weight: 600;
    }
    
    .null-value {
        color: #95a5a6;
        font-style: italic;
    }
    
    .subvariable-block {
        margin-left: 15px;
        margin-top: 12px;
        padding: 10px;
        background: white;
        border-radius: 4px;
        border-left: 2px solid #95a5a6;
        display: none; /* Hidden since subvariables are now in main table */
    }
    
    .subvariable-name {
        font-size: 13px;
        font-weight: 600;
        color: #34495e;
        margin-bottom: 8px;
    }
    
    .notes-box {
        margin-top: 12px;
        padding: 10px;
        background: #fffbf0;
        border-left: 3px solid #f39c12;
        border-radius: 4px;
    }
    
    .notes-title {
        font-weight: 600;
        color: #d68910;
        margin-bottom: 6px;
        font-size: 12px;
    }
    
    .notes-content {
        color: #555;
        font-size: 12px;
        line-height: 1.5;
    }
    
    
    canvas {
        max-height: 250px !important;
    }
    
    .loading {
        text-align: center;
        padding: 15px;
        color: #7f8c8d;
    }
    
    @media print {
        body {
            background: white;
        }
        
        .category-card, .variable-block {
            page-break-inside: avoid;
        }
        
        button, input[type="file"] {
            display: none;
        }
    }
</style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Analytics Report Dashboard</h1>
            <div class="file-input-group">
                <input type="file" id="fileInput" accept="application/json">
                <button id="exportBtn" disabled>Export naar PDF</button>
            </div>
            <div id="errorMsg"></div>
        </header>
        
        <div id="reportContent"></div>
    </div>

<script>
    // Global data store
    let jsonData = null;
    let chartInstances = [];
    
    // File input handler
    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                jsonData = JSON.parse(event.target.result);
                renderReport(jsonData);
                document.getElementById('exportBtn').disabled = false;
                document.getElementById('errorMsg').innerHTML = '';
            } catch (err) {
                showError('Ongeldige JSON: ' + err.message);
            }
        };
        reader.readAsText(file);
    });
    
    // Export button handler
    document.getElementById('exportBtn').addEventListener('click', () => {
        exportToPDF();
    });
    
    // Show error message
    function showError(msg) {
        document.getElementById('errorMsg').innerHTML = `<div class="error">${msg}</div>`;
        document.getElementById('reportContent').innerHTML = '';
        document.getElementById('exportBtn').disabled = true;
    }
    
    // Trim whitespace from variable names
    function trimName(name) {
        return name.replace(/\s+/g, ' ').trim();
    }
    
    // Calculate delta between current and previous non-null value
    function calculateDelta(data, weeks, currentIndex) {
        if (currentIndex === 0) return null;
        
        const currentValue = data[weeks[currentIndex]];
        if (currentValue === null) return null;
        
        // Find previous non-null value
        for (let i = currentIndex - 1; i >= 0; i--) {
            const prevValue = data[weeks[i]];
            if (prevValue !== null) {
                return currentValue - prevValue;
            }
        }
        
        return null; // First non-null value
    }
    
    // Format delta for display
    function formatDelta(delta, unit) {
        if (delta === null) return '';
        const sign = delta >= 0 ? '+' : '';
        const className = delta >= 0 ? 'delta-positive' : 'delta-negative';
        return `<span class="${className}">${sign}${delta}${unit}</span>`;
    }
    
    // Natural sort for week labels - **WIJZIGING** (Beter sorteren + week 5 uitsluiten)
    function sortWeeks(weeks) {
        const sorted = weeks.sort((a, b) => {
            // Extraheren van het weeknummer (bijv. 1 uit 'week 1')
            const numA = parseInt(a.match(/\d+/)?.[0] || '0');
            const numB = parseInt(b.match(/\d+/)?.[0] || '0');
            return numA - numB;
        });
        
        // **NIEUWE CODE**: Filter week 5 uit de gesorteerde lijst
        return sorted.filter(week => !week.toLowerCase().includes('week 5'));
    }
    
    // Render horizontal data table with main variable and subvariables combined
    function renderCombinedTable(variable, unit, varId) {
        const weeks = sortWeeks(Object.keys(variable.data));
        
        let html = '<div class="data-table-horizontal"><table class="horizontal-layout">';
        
        // Header row with checkbox column + variable name column + week labels
        html += '<thead><tr>';
        html += '<th>PDF</th>'; // Checkbox column header
        html += '<th></th>'; // Empty cell for variable names column
        weeks.forEach(week => {
            html += `<th>${week}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        // Main variable row
        html += '<tr>';
        html += `<td><input type="checkbox" class="pdf-select-row" data-var="${varId}" data-type="main" checked></td>`;
        html += `<td>${trimName(variable.name)}</td>`;
        weeks.forEach((week, index) => {
            const value = variable.data[week];
            const delta = calculateDelta(variable.data, weeks, index);
            let cellContent = value !== null ? value + unit : '<span class="null-value">‚Äì</span>';
            if (delta !== null && delta !== 0) {
                cellContent += ' ' + formatDelta(delta, unit);
            }
            html += `<td>${cellContent}</td>`;
        });
        html += '</tr>';
        
        // Subvariables rows
        if (variable.subVariables && variable.subVariables.length > 0) {
            variable.subVariables.forEach((subVar, subIdx) => {
                const subId = `${varId}-sub${subIdx}`;
                html += '<tr class="subvar-row">';
                html += `<td><input type="checkbox" class="pdf-select-row" data-var="${varId}" data-subvar="${subId}" data-type="sub" checked></td>`;
                html += `<td>${trimName(subVar.name)}</td>`;
                weeks.forEach((week, index) => {
                    const value = subVar.data[week];
                    const delta = calculateDelta(subVar.data, weeks, index);
                    let cellContent = value !== null ? value + unit : '<span class="null-value">‚Äì</span>';
                    if (delta !== null && delta !== 0) {
                        cellContent += ' ' + formatDelta(delta, unit);
                    }
                    html += `<td>${cellContent}</td>`;
                });
                html += '</tr>';
            });
        }
        
        html += '</tbody></table></div>';
        return html;
    }
    
    // Create chart for variable
    function createChart(canvasId, variable, categoryName) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;
        
        const weeks = sortWeeks(Object.keys(variable.data));
        
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: weeks,
                datasets: [] // Wordt gevuld door updateChart
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            font: {
                                size: 10
                            },
                            boxWidth: 12,
                            padding: 8
                        }
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    }
                }
            }
        });
        
        chartInstances.push(chart);

        // Laad de initi√´le data na het aanmaken van de Chart.js instantie
        const varId = canvasId.replace('chart-', '');
        updateChart(canvasId, jsonData, varId);
    }

    // NIEUWE FUNCTIE: Update de grafiek op basis van checkbox selectie
    function updateChart(chartId, data, varId) {
        const chart = chartInstances.find(instance => instance.canvas.id === chartId);
        if (!chart) return;

        // Zoek de variabele in de jsonData
        let variable = null;
        const [categoryKey, varIdx] = varId.split('-');
        if (data[categoryKey] && data[categoryKey].variables) {
            variable = data[categoryKey].variables[parseInt(varIdx)];
        }
        if (!variable) return;

        const weeks = sortWeeks(Object.keys(variable.data));
        const newDatasets = [];

        // Hulpkleuren voor subvariabelen (moet overeenkomen met createChart)
        const subColors = ['#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#34495e'];

        // 1. Controleer de Main Variable checkbox
        const mainCheckbox = document.querySelector(`input[data-var="${varId}"][data-type="main"]`);
        if (mainCheckbox && mainCheckbox.checked) {
            // Main variable dataset
            newDatasets.push({
                label: trimName(variable.name),
                data: weeks.map(w => variable.data[w]),
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 3
            });
        }

        // 2. Controleer de Subvariables checkboxes
        if (variable.subVariables && variable.subVariables.length > 0) {
            variable.subVariables.forEach((subVar, idx) => {
                const subId = `${varId}-sub${idx}`;
                const subCheckbox = document.querySelector(`input[data-var="${varId}"][data-subvar="${subId}"][data-type="sub"]`);

                // Toon ALLEEN als de checkbox is aangevinkt
                if (subCheckbox && subCheckbox.checked) {
                    newDatasets.push({
                        label: trimName(subVar.name),
                        data: weeks.map(w => subVar.data[w]),
                        borderColor: subColors[idx % subColors.length],
                        backgroundColor: subColors[idx % subColors.length] + '20',
                        tension: 0.3,
                        borderWidth: 2,
                        pointRadius: 2
                    });
                }
            });
        }

        // Update de grafiek data en herteken
        chart.data.datasets = newDatasets;
        chart.update();
    }
    
    // Render complete report
    function renderReport(data) {
        // Destroy existing charts
        chartInstances.forEach(chart => chart.destroy());
        chartInstances = [];
        
        const content = document.getElementById('reportContent');
        let html = '';
        
        Object.keys(data).forEach(categoryKey => {
            const category = data[categoryKey];
            html += `<div class="category-card" data-category="${categoryKey}">`;
            html += `<h2 class="category-title">${categoryKey}</h2>`;
            
            if (category.variables) {
                category.variables.forEach((variable, varIdx) => {
                    const varId = `${categoryKey}-${varIdx}`;
                    const cleanName = trimName(variable.name);
                    const unit = variable.unit || '';
                    
                    html += `<div class="variable-block" data-variable="${varId}">`;
                    html += `<div class="variable-header">`;
                    html += `<div class="variable-name">${cleanName}</div>`;
                    html += `<div class="variable-meta">`;
                    
                    if (variable.tags && variable.tags.length > 0) {
                        variable.tags.forEach(tag => {
                            html += `<span class="tag">${tag}</span>`;
                        });
                    }
                    
                    if (unit) {
                        html += `<span class="unit">(${unit})</span>`;
                    }
                    
                    html += `</div></div>`;
                    
                    // Combined table with main variable and subvariables
                    html += `<div class="data-container">`;
                    html += `<div class="data-section">`;
                    html += renderCombinedTable(variable, unit, varId);
                    html += `</div>`;
                    
                    // Chart
                    const chartId = `chart-${varId}`;
                    html += `<div class="chart-container"><canvas id="${chartId}"></canvas></div>`;
                    
                    html += `</div>`; // Close data-container
                    
                    // Notes
                    if (variable.notes && variable.notes.trim()) {
                        html += `<div class="notes-box" data-notes="${varId}">`;
                        html += `<div class="notes-title">üìù Opmerkingen</div>`;
                        html += `<div class="notes-content">${variable.notes}</div>`;
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                });
            }
            
            html += `</div>`;
        });
        
        content.innerHTML = html;
        
        // Create charts after DOM update
        setTimeout(() => {
            Object.keys(data).forEach(categoryKey => {
                const category = data[categoryKey];
                if (category.variables) {
                    category.variables.forEach((variable, varIdx) => {
                        const varId = `${categoryKey}-${varIdx}`;
                        const chartId = `chart-${varId}`;
                        createChart(chartId, variable, categoryKey);
                    });
                    
                    // Small delay before PDF is ready to be generated
                    setTimeout(() => {
                        document.getElementById('exportBtn').disabled = false;
                    }, 500);
                }
            });

            // Event listener toevoegen voor alle checkboxes
            document.querySelectorAll('.pdf-select-row').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const varId = e.target.dataset.var;
                    const chartId = `chart-${varId}`;
                    // Update de grafiek met de nieuwe selectie
                    updateChart(chartId, jsonData, varId);	
                });
            });

        }, 100);
    }
    
    // Export to PDF with charts and selective rows - OPTIMIZED FOR FILE SIZE
    async function exportToPDF() {
        const btn = document.getElementById('exportBtn');
        btn.disabled = true;
        btn.textContent = 'PDF genereren...';
        
        try {
            const { jsPDF } = window.jspdf;
            
            // Start PDF in 'landscape' (liggend) A4
            const pdf = new jsPDF('landscape', 'mm', 'a4');
            let firstPage = true;
            
            const blocks = document.querySelectorAll('.variable-block');
            
            for (const block of blocks) {
                const varId = block.dataset.variable;
                
                // Check if main variable is selected
                const mainCheckbox = block.querySelector(`input[data-var="${varId}"][data-type="main"]`);
                if (!mainCheckbox || !mainCheckbox.checked) continue;
                
                // Clone and prepare element for capture
                const clone = block.cloneNode(true);
                
                // Remove checkbox column and unchecked rows from table
                const table = clone.querySelector('table');
                if (table) {
                    // Remove header checkbox column
                    const headerRow = table.querySelector('thead tr');
                    if (headerRow) {
                        headerRow.deleteCell(0);
                    }
                    
                    // Remove checkbox cells from all data rows and remove unchecked rows
                    const rows = Array.from(table.querySelectorAll('tbody tr'));
                    rows.forEach((row, idx) => {
                        // Find the original checkbox status
                        const originalCheckbox = block.querySelectorAll('tbody tr input[type="checkbox"]')[idx];
                        
                        if (!originalCheckbox || !originalCheckbox.checked) {
                            row.remove();
                            return;
                        }
                        
                        // **WIJZIGING**: De cellen zijn nu in de kloon
                        const cellToDelete = row.cells[0]; 
                        if (cellToDelete) {
                            cellToDelete.remove();
                        }
                    });

                    // **NIEUWE CODE**: Fix de uitlijning in de kloon door de CSS aan te passen
                    // Dit richt zich op de tweede kolom (naam van de variabele)
                    const tableClone = clone.querySelector('table.horizontal-layout');
                    if(tableClone) {
                        const style = document.createElement('style');
                        style.textContent = `
                            .horizontal-layout th:nth-child(1) { min-width: 180px; max-width: 200px; } /* Naam kolom is nu de 1e kolom */
                            .horizontal-layout td:nth-child(1) { padding-left: 10px; text-align: left; background: #f8f9fa; max-width: 200px; }
                            .subvar-row td:nth-child(1) { padding-left: 20px; }
                        `;
                        clone.appendChild(style);
                    }

                }
                
                // Clone the chart image data
                const originalCanvas = block.querySelector('canvas');
                const clonedCanvas = clone.querySelector('canvas');
                
                if (originalCanvas && clonedCanvas) {
                    // De grafiek is al ge√ºpdatet met de juiste selectie door de updateChart-functie
                    const ctx = clonedCanvas.getContext('2d');
                    clonedCanvas.width = originalCanvas.width;
                    clonedCanvas.height = originalCanvas.height;
                    ctx.drawImage(originalCanvas, 0, 0);
                }
                
                // Set temporary styles for optimal html2canvas rendering
                clone.style.position = 'absolute';
                clone.style.left = '-9999px';
                clone.style.top = '0';
                clone.style.width = '1100px'; // Set width for a good landscape fit
                clone.style.padding = '15px';
                clone.style.background = '#ffffff'; // Force white background
                document.body.appendChild(clone);
                
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Capture with html2canvas - verlaagde schaal voor kleinere bestandsgrootte
                const canvas = await html2canvas(clone, {
                    scale: 1.2, // Verlaagd van 1.5 of 2.0 voor kleinere bestanden
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    allowTaint: true,
                    windowWidth: 1100,
                    windowHeight: clone.scrollHeight
                });
                
                // Remove clone from DOM
                document.body.removeChild(clone);
                
                // Add page if not first
                if (!firstPage) {
                    pdf.addPage();
                }
                firstPage = false;
                
                // Convert canvas to JPEG to reduce file size (quality 0.8)
                const imgData = canvas.toDataURL('image/jpeg', 0.8);
                
                // Calculate optimal size for A4 landscape
                const pdfWidth = pdf.internal.pageSize.getWidth() - 20; // 10mm margin each side
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                const pageHeight = pdf.internal.pageSize.getHeight() - 20;
                
                if (pdfHeight <= pageHeight) {
                    // Fits nicely, centered
                    pdf.addImage(imgData, 'JPEG', 10, 10, pdfWidth, pdfHeight);
                } else {
                    // Too tall, scale down to fit height
                    const scale = pageHeight / pdfHeight;
                    const scaledWidth = pdfWidth * scale;
                    const scaledHeight = pageHeight;
                    pdf.addImage(imgData, 'JPEG', 10, 10, scaledWidth, scaledHeight);
                }
            }
            
            // Save PDF
            pdf.save('analytics-report-optimized.pdf');
            
        } catch (err) {
            alert('Fout bij PDF export: ' + err.message);
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Export naar PDF';
        }
    }
</script>
</body>
</html>
