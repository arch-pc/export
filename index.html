<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Data Exporter</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- Base & Layout --- */
        :root {
            --color-bg: #f4f7f6;
            --color-card: #ffffff;
            --color-border: #e0e0e0;
            --color-text-primary: #333;
            --color-text-secondary: #666;
            --color-primary: #007bff;
            --color-delta-pos: #28a745;
            --color-delta-neg: #dc3545;
            --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 4px 10px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            margin: 0;
            padding: 0;
            font-size: 15px;
            line-height: 1.6;
        }

        header {
            background-color: var(--color-card);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-light);
        }

        header h1 {
            margin: 0;
            font-size: 1.75rem;
            color: var(--color-primary);
        }

        .controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        input[type="file"] {
            font-size: 0.9rem;
        }

        button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }

        button:hover {
            background-color: #0056b3;
            box-shadow: var(--shadow-light);
        }
        
        button:disabled {
            background-color: #c0c0c0;
            cursor: not-allowed;
        }

        #error-message {
            width: 100%;
            color: var(--color-delta-neg);
            font-weight: 600;
            margin-top: 0.5rem;
        }

        main {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* --- Category & Variable Containers --- */
        .category-container {
            background-color: var(--color-card);
            border-radius: 8px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 2rem;
            overflow: hidden; /* Ensures box-shadow works with border-radius */
        }

        .category-header {
            font-size: 1.8rem;
            font-weight: 700;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .variable-container {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--color-border);
        }
        .variable-container:last-child {
            border-bottom: none;
        }
        
        /* This CSS is used by jsPDF to avoid splitting elements */
        @media print {
            .variable-container, .category-container {
                page-break-inside: avoid;
            }
        }

        .variable-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .variable-info {
            flex-grow: 1;
        }

        .variable-name {
            font-size: 1.4rem;
            font-weight: 600;
            margin: 0 0 0.25rem 0;
            display: inline-block;
        }

        .variable-unit {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            font-weight: 400;
            margin-left: 0.5rem;
        }

        .tags {
            margin-top: 0.5rem;
        }

        .tag {
            display: inline-block;
            background-color: var(--color-bg);
            border: 1px solid var(--color-border);
            color: var(--color-text-secondary);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-right: 0.25rem;
            text-transform: capitalize;
        }

        /* --- PDF Selection Checkboxes --- */
        .pdf-selection {
            background-color: #f9f9f9;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            flex-shrink: 0; /* Prevents shrinking */
            user-select: none;
        }
        
        .pdf-selection input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--color-primary);
        }
        .pdf-selection label {
            cursor: pointer;
            font-weight: 500;
            color: #444;
        }

        /* --- Data Table --- */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.95rem;
        }

        .data-table th,
        .data-table td {
            border: 1px solid var(--color-border);
            padding: 0.75rem 1rem;
            text-align: left;
            vertical-align: top;
        }

        .data-table th {
            background-color: var(--color-bg);
            font-weight: 600;
        }

        .data-table td:nth-child(2),
        .data-table td:nth-child(3) {
            text-align: right;
            font-family: "Menlo", "Consolas", monospace;
        }

        .delta-positive {
            color: var(--color-delta-pos);
        }
        
        .delta-negative {
            color: var(--color-delta-neg);
        }

        /* --- Sub-variables --- */
        .sub-variables-wrapper {
            margin-top: 1.5rem;
            padding-left: 1.5rem;
            border-left: 3px solid var(--color-primary);
        }
        
        .sub-variable-container {
            padding: 1rem 0 1rem 1rem;
            border-bottom: 1px dashed var(--color-border);
        }
        .sub-variable-container:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .sub-variable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .sub-variable-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #444;
        }

        /* --- Notes & Charts --- */
        .notes {
            background-color: #fffbeb;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 1rem 1.25rem;
            border-radius: 6px;
            margin-top: 1.5rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .notes strong {
            color: #664d03;
        }

        .chart-container {
            position: relative;
            height: 300px; /* Fixed height for charts */
            width: 100%;
            margin-top: 1.5rem;
        }

        /* --- Loader Overlay --- */
        .loader-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            z-index: 9998;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1rem;
        }
        
        .loader-spinner {
            border: 6px solid var(--color-bg);
            border-top: 6px solid var(--color-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        .loader-overlay p {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <header>
        <h1>Marketing Data Report</h1>
        <div class="controls">
            <input type="file" id="jsonUploader" accept="application/json">
            <button id="exportPdfBtn" style="display:none;" disabled>Export to PDF</button>
        </div>
        <div id="error-message"></div>
    </header>

    <main id="report-container"></main>

    <div id="loader" class="loader-overlay">
        <div class="loader-spinner"></div>
        <p>Generating PDF, please wait...</p>
    </div>

    <script>
        // Store references to DOM elements
        let uploader, exportBtn, reportContainer, errorMsg, loader;
        let allWeekLabels = [];
        let chartInstances = []; // To destroy charts before re-render
        let varCounter = 0; // For unique IDs
        
        // Chart.js colors
        const CHART_COLORS = [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', 
            '#858796', '#5a5c69', '#f8f9fc', '#e74a3b', '#fd7e14'
        ];

        document.addEventListener('DOMContentLoaded', () => {
            // Find all our key elements
            uploader = document.getElementById('jsonUploader');
            exportBtn = document.getElementById('exportPdfBtn');
            reportContainer = document.getElementById('report-container');
            errorMsg = document.getElementById('error-message');
            loader = document.getElementById('loader');

            // Add event listeners
            uploader.addEventListener('change', handleFileUpload);
            exportBtn.addEventListener('click', exportToPDF);
        });

        /**
         * Handles the file upload event, reads the file, and triggers parsing.
         */
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    // Clear previous errors and content
                    errorMsg.textContent = '';
                    destroyCharts();
                    reportContainer.innerHTML = '';
                    varCounter = 0; // Reset ID counter
                    
                    const data = JSON.parse(e.target.result);
                    
                    // Process and render the report
                    allWeekLabels = collectAllWeeks(data);
                    renderReport(data);

                    // Show and enable the export button
                    exportBtn.style.display = 'inline-block';
                    exportBtn.disabled = false;

                } catch (err) {
                    console.error("JSON Parsing Error:", err);
                    errorMsg.textContent = 'Error: Invalid JSON file. Please check the file format.';
                    reportContainer.innerHTML = '';
                    exportBtn.style.display = 'none';
                    exportBtn.disabled = true;
                }
            };

            reader.onerror = () => {
                errorMsg.textContent = 'Error: Could not read the file.';
                exportBtn.style.display = 'none';
            };

            reader.readAsText(file);
        }

        /**
         * Destroys all active Chart.js instances to prevent memory leaks.
         */
        function destroyCharts() {
            chartInstances.forEach(chart => chart.destroy());
            chartInstances = [];
        }

        /**
         * Finds all unique, sorted week labels from the entire dataset.
         */
        function collectAllWeeks(data) {
            const weekSet = new Set();
            for (const categoryName in data) {
                const category = data[categoryName];
                if (category.variables) {
                    for (const variable of category.variables) {
                        if (variable.data) {
                            Object.keys(variable.data).forEach(week => weekSet.add(week));
                        }
                        // Also check sub-variables
                        if (variable.subVariables) {
                            for (const subVar of variable.subVariables) {
                                if (subVar.data) {
                                    Object.keys(subVar.data).forEach(week => weekSet.add(week));
                                }
                            }
                        }
                    }
                }
            }
            
            // Sort weeks naturally (e.g., "Week 1", "Week 2", "Week 10")
            return Array.from(weekSet).sort((a, b) => {
                const numA = parseInt(a.split(' ')[1] || 0);
                const numB = parseInt(b.split(' ')[1] || 0);
                return numA - numB;
            });
        }

        /**
         * Main function to render the entire report structure from parsed JSON.
         */
        function renderReport(data) {
            for (const categoryName in data) {
                const category = data[categoryName];
                
                // 1. Create Category Container
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-container';
                
                const categoryHeader = document.createElement('h2');
                categoryHeader.className = 'category-header';
                categoryHeader.textContent = categoryName;
                categoryDiv.appendChild(categoryHeader);

                // 2. Loop through variables in the category
                if (category.variables) {
                    for (const variable of category.variables) {
                        const varId = 'var-' + (varCounter++);
                        
                        // 3. Create Variable Container
                        const variableDiv = document.createElement('div');
                        variableDiv.className = 'variable-container';
                        variableDiv.dataset.variableId = varId;

                        // 4. Render Variable Header (Name, Tags, Checkbox)
                        variableDiv.appendChild(renderVariableHeader(variable, varId));

                        // 5. Render Main Variable Data Table
                        if (variable.data) {
                            variableDiv.appendChild(createDataTable(variable, allWeekLabels));
                        }

                        // 6. Render Sub-Variables
                        if (variable.subVariables && variable.subVariables.length > 0) {
                            const subVarsWrapper = document.createElement('div');
                            subVarsWrapper.className = 'sub-variables-wrapper';
                            
                            for (const subVar of variable.subVariables) {
                                const subVarId = 'subvar-' + (varCounter++);
                                const subVarContainer = document.createElement('div');
                                subVarContainer.className = 'sub-variable-container';
                                subVarContainer.dataset.subvariableId = subVarId;
                                
                                // Sub-var header + checkbox
                                subVarContainer.appendChild(renderSubVariableHeader(subVar, subVarId));
                                
                                // Sub-var data table
                                if (subVar.data) {
                                    subVarContainer.appendChild(createDataTable(subVar, allWeekLabels, true));
                                }
                                
                                subVarsWrapper.appendChild(subVarContainer);
                            }
                            variableDiv.appendChild(subVarsWrapper);
                        }

                        // 7. Render Notes
                        if (variable.notes && variable.notes.trim() !== "") {
                            variableDiv.appendChild(renderNotes(variable.notes));
                        }

                        // 8. Render Chart
                        const chartContainer = document.createElement('div');
                        chartContainer.className = 'chart-container';
                        const canvas = document.createElement('canvas');
                        chartContainer.appendChild(canvas);
                        variableDiv.appendChild(chartContainer);
                        
                        renderChart(canvas, variable, allWeekLabels);

                        // Add the completed variable block to the category
                        categoryDiv.appendChild(variableDiv);
                    }
                }
                // Add the completed category to the main report container
                reportContainer.appendChild(categoryDiv);
            }
        }

        /**
         * Creates the header block for a main variable.
         */
        function renderVariableHeader(variable, varId) {
            const headerDiv = document.createElement('div');
            headerDiv.className = 'variable-header';

            const infoDiv = document.createElement('div');
            infoDiv.className = 'variable-info';
            
            const nameEl = document.createElement('h3');
            nameEl.className = 'variable-name';
            nameEl.textContent = variable.name.trim();
            infoDiv.appendChild(nameEl);

            if (variable.unit && variable.unit.trim() !== "") {
                const unitEl = document.createElement('span');
                unitEl.className = 'variable-unit';
                unitEl.textContent = `(Unit: ${variable.unit})`;
                infoDiv.appendChild(unitEl);
            }

            if (variable.tags && variable.tags.length > 0) {
                const tagsDiv = document.createElement('div');
                tagsDiv.className = 'tags';
                variable.tags.forEach(tag => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'tag';
                    tagEl.textContent = tag;
                    tagsDiv.appendChild(tagEl);
                });
                infoDiv.appendChild(tagsDiv);
            }
            
            headerDiv.appendChild(infoDiv);
            headerDiv.appendChild(createPdfCheckbox(varId, 'Include in PDF', true));
            return headerDiv;
        }

        /**
         * Creates the header block for a sub-variable.
         */
        function renderSubVariableHeader(subVar, subVarId) {
            const headerDiv = document.createElement('div');
            headerDiv.className = 'sub-variable-header';
            
            const nameEl = document.createElement('h4');
            nameEl.className = 'sub-variable-name';
            nameEl.textContent = subVar.name.trim();
            headerDiv.appendChild(nameEl);
            
            headerDiv.appendChild(createPdfCheckbox(subVarId, 'Include', true));
            return headerDiv;
        }

        /**
         * Factory function to create a PDF selection checkbox.
         */
        function createPdfCheckbox(id, labelText, isMainVar = false) {
            const checkboxId = 'check-' + id;
            
            const selectionDiv = document.createElement('div');
            selectionDiv.className = 'pdf-selection';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = checkboxId;
            checkbox.dataset.id = id;
            if (isMainVar) {
                checkbox.dataset.variableId = id; // Mark as main var
            }
            checkbox.checked = true; // Default to checked
            
            const label = document.createElement('label');
            label.htmlFor = checkboxId;
            label.textContent = labelText;
            
            selectionDiv.appendChild(checkbox);
            selectionDiv.appendChild(label);
            return selectionDiv;
        }

        /**
         * Creates the HTML table for a given variable's data.
         */
        function createDataTable(variable, weeks, isSubVariable = false) {
            const table = document.createElement('table');
            table.className = 'data-table';
            
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            headerRow.innerHTML = '<th>Week</th><th>Value</th><th>Delta</th>';
            
            const tbody = table.createTBody();
            let lastNonNullValue = null;

            for (const week of weeks) {
                const value = variable.data ? variable.data[week] : undefined;
                const isNull = (value === null || value === undefined);
                
                let displayValue = '–';
                if (!isNull) {
                    // Add unit if it exists (only for main variable)
                    const unitSuffix = (!isSubVariable && variable.unit) ? ` ${variable.unit}` : '';
                    displayValue = value.toLocaleString('en-US') + unitSuffix;
                }
                
                let delta = '–';
                let deltaClass = '';

                if (!isNull) {
                    if (lastNonNullValue !== null) {
                        const deltaValue = value - lastNonNullValue;
                        delta = deltaValue.toLocaleString('en-US');
                        if (deltaValue > 0) {
                            deltaClass = 'delta-positive';
                            delta = '+' + delta;
                        } else if (deltaValue < 0) {
                            deltaClass = 'delta-negative';
                        }
                    }
                    lastNonNullValue = value;
                }

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${week}</td>
                    <td>${displayValue}</td>
                    <td class="${deltaClass}">${delta}</td>
                `;
            }
            return table;
        }

        /**
         * Renders the notes block if notes exist.
         */
        function renderNotes(notes) {
            const notesDiv = document.createElement('div');
            notesDiv.className = 'notes';
            // Use innerHTML to render any potential simple formatting, but be aware of XSS if source is untrusted.
            // For this project, assuming trusted JSON.
            notesDiv.innerHTML = `<strong>Notes:</strong> ${notes.trim().replace(/\n/g, '<br>')}`;
            return notesDiv;
        }

        /**
         * Renders a Chart.js chart for a main variable and its sub-variables.
         */
        function renderChart(canvas, mainVariable, weeks) {
            const ctx = canvas.getContext('2d');
            const datasets = [];

            // 1. Add Main Variable Dataset
            if (mainVariable.data) {
                datasets.push({
                    label: mainVariable.name.trim(),
                    data: weeks.map(week => mainVariable.data[week] ?? null),
                    borderColor: CHART_COLORS[0],
                    backgroundColor: CHART_COLORS[0],
                    borderWidth: 3,
                    fill: false,
                    tension: 0.1
                });
            }

            // 2. Add Sub-Variable Datasets
            if (mainVariable.subVariables) {
                mainVariable.subVariables.forEach((subVar, index) => {
                    if (subVar.data) {
                        const color = CHART_COLORS[(index + 1) % CHART_COLORS.length];
                        datasets.push({
                            label: `  ${subVar.name.trim()}`, // Indent label
                            data: weeks.map(week => subVar.data[week] ?? null),
                            borderColor: color,
                            backgroundColor: color,
                            borderWidth: 2,
                            borderDash: [5, 5], // Dashed line for sub-vars
                            fill: false,
                            tension: 0.1
                        });
                    }
                });
            }
            
            // 3. Create the Chart
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    spanGaps: false, // Prevents drawing lines through null/missing data
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                            }
                        }
                    }
                }
            });
            chartInstances.push(chart); // Store for later destruction
        }

        /**
         * Handles the PDF export logic, section by section.
         */
        async function exportToPDF() {
            loader.style.display = 'flex';
            exportBtn.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                // A4 Landscape: 297mm (w) x 210mm (h)
                const A4_WIDTH_MM = 297;
                const A4_HEIGHT_MM = 210;
                const MARGIN_MM = 10;
                const MAX_WIDTH_MM = A4_WIDTH_MM - (MARGIN_MM * 2);
                const MAX_HEIGHT_MM = A4_HEIGHT_MM - (MARGIN_MM * 2);
                
                // Fixed width for rendering elements before canvas capture.
                // 1123px is approx A4 width at 96DPI. We use 1100 for safety.
                const RENDER_WIDTH_PX = 1100;

                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                let pdfY = MARGIN_MM; // Current y position in PDF
                let pageCount = 1;

                // Get all top-level variable containers
                const containers = document.querySelectorAll('.variable-container');

                for (const container of containers) {
                    const mainCheckbox = container.querySelector('input[data-variable-id]');
                    
                    // 1. Skip this container if its main checkbox is unchecked
                    if (!mainCheckbox || !mainCheckbox.checked) {
                        continue;
                    }

                    // 2. Clone the container to modify it for PDF output
                    const elClone = container.cloneNode(true);
                    
                    // 3. Filter sub-variables in the clone
                    const subVarsInClone = elClone.querySelectorAll('.sub-variable-container');
                    subVarsInClone.forEach(subVarClone => {
                        const subVarId = subVarClone.dataset.subvariableId;
                        const originalSubCheckbox = document.getElementById('check-' + subVarId);
                        
                        // If original checkbox is unchecked, remove this sub-var from the clone
                        if (originalSubCheckbox && !originalSubCheckbox.checked) {
                            subVarClone.remove();
                        }
                    });

                    // 4. Remove all checkbox/selection UI from the clone
                    elClone.querySelectorAll('.pdf-selection').forEach(el => el.remove());

                    // 5. Prepare the clone for off-screen rendering
                    elClone.style.position = 'absolute';
                    elClone.style.left = '-9999px';
                    elClone.style.top = '0';
                    elClone.style.width = `${RENDER_WIDTH_PX}px`; // Set fixed width
                    elClone.style.backgroundColor = 'white'; // Ensure non-transparent bg
                    document.body.appendChild(elClone);

                    // 6. Capture the clone with html2canvas
                    const canvas = await html2canvas(elClone, {
                        scale: 2, // Higher scale for better quality
                        width: RENDER_WIDTH_PX,
                        windowWidth: RENDER_WIDTH_PX
                    });

                    // 7. Clean up the clone from the DOM
                    document.body.removeChild(elClone);

                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;

                    // Calculate image dimensions in mm
                    const ratio = imgHeight / imgWidth;
                    const imgHeightMM = MAX_WIDTH_MM * ratio;

                    // 8. Check if it fits on the current page
                    // (Check if it *will* overflow, and ensure we're not on a blank page)
                    if (pdfY > MARGIN_MM && (pdfY + imgHeightMM > MAX_HEIGHT_MM)) {
                        pdf.addPage();
                        pageCount++;
                        pdfY = MARGIN_MM; // Reset Y position for new page
                    }
                    
                    // 9. Handle content taller than one page (unlikely for one var, but good to have)
                    let imgY = 0;
                    while (imgY < imgHeightMM) {
                        let h = imgHeightMM - imgY;
                        if (h > MAX_HEIGHT_MM - pdfY) {
                            h = MAX_HEIGHT_MM - pdfY;
                        }

                        // Use addImage with source coordinates (sx, sy, sw, sh)
                        // This is complex. A simpler way is to just add a new page
                        // if the *entire element* is too tall.
                        
                        // Simpler logic: If a single element is taller than a page,
                        // it will be added and clipped. For this use case, we
                        // assume one variable container fits on one page.
                        // The previous check (pdfY + imgHeightMM > MAX_HEIGHT_MM) is sufficient.

                        pdf.addImage(imgData, 'PNG', MARGIN_MM, pdfY, MAX_WIDTH_MM, imgHeightMM);
                        pdfY += imgHeightMM + 5; // Add image height + 5mm padding
                        imgY += h;

                        if (imgY < imgHeightMM) {
                            pdf.addPage();
                            pageCount++;
                            pdfY = MARGIN_MM;
                        }
                    }
                }
                
                // 10. Save the final PDF
                pdf.save('marketing-report.pdf');

            } catch (err) {
                console.error("PDF Export Error:", err);
                errorMsg.textContent = "An error occurred during PDF export. Please try again.";
            } finally {
                // Hide loader and re-enable button
                loader.style.display = 'none';
                exportBtn.disabled = false;
            }
        }

    </script>

</body>
</html>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-gray: #f5f7fa;
            --medium-gray: #e1e8ed;
            --dark-gray: #34495e;
            --text-color: #2c3e50;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--light-gray);
            padding: var(--spacing-md);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        h1 {
            font-size: 24px;
            color: var(--dark-gray);
        }

        .controls {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }

        input[type="file"] {
            padding: var(--spacing-sm);
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #2980b9;
        }

        #export-pdf {
            background-color: var(--secondary-color);
        }

        #export-pdf:hover {
            background-color: #27ae60;
        }

        .category {
            margin-bottom: var(--spacing-lg);
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        .category-header {
            background-color: var(--dark-gray);
            color: white;
            padding: var(--spacing-md);
            font-size: 20px;
            font-weight: 600;
        }

        .variable {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--medium-gray);
        }

        .variable:last-child {
            border-bottom: none;
        }

        .variable-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
        }

        .variable-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .variable-name {
            font-size: 18px;
            font-weight: 600;
        }

        .tags {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .tag {
            background-color: var(--medium-gray);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .unit {
            font-size: 14px;
            color: var(--dark-gray);
            margin-left: var(--spacing-sm);
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .checkbox-container input {
            width: 18px;
            height: 18px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--spacing-md);
        }

        th, td {
            padding: var(--spacing-sm);
            text-align: center;
            border: 1px solid var(--medium-gray);
        }

        th {
            background-color: var(--light-gray);
            font-weight: 600;
        }

        .delta-positive {
            color: var(--secondary-color);
            font-weight: 600;
        }

        .delta-negative {
            color: var(--danger-color);
            font-weight: 600;
        }

        .subvariable {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background-color: var(--light-gray);
            border-radius: var(--border-radius);
        }

        .subvariable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .subvariable-name {
            font-weight: 500;
        }

        .notes {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background-color: #fff9e6;
            border-left: 4px solid var(--warning-color);
            border-radius: var(--border-radius);
        }

        .chart-container {
            margin-top: var(--spacing-md);
            height: 300px;
            position: relative;
        }

        .error-message {
            padding: var(--spacing-md);
            background-color: #ffebee;
            color: var(--danger-color);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-md);
            display: none;
        }

        .hidden {
            display: none !important;
        }

        @media print {
            body {
                background-color: white;
                padding: 0;
            }
            
            .controls, button {
                display: none;
            }
            
            .category {
                box-shadow: none;
                border: 1px solid var(--medium-gray);
                break-inside: avoid;
            }
            
            .chart-container {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Analytics Dashboard</h1>
            <div class="controls">
                <input type="file" id="file-upload" accept="application/json">
                <button id="select-all">Select All</button>
                <button id="deselect-all">Deselect All</button>
                <button id="export-pdf">Export to PDF</button>
            </div>
        </header>
        
        <div id="error-message" class="error-message"></div>
        
        <div id="dashboard"></div>
    </div>

    <script>
        // Global variables
        let chartInstances = [];
        let jsonData = null;

        // DOM elements
        const fileUpload = document.getElementById('file-upload');
        const dashboard = document.getElementById('dashboard');
        const errorMessage = document.getElementById('error-message');
        const selectAllBtn = document.getElementById('select-all');
        const deselectAllBtn = document.getElementById('deselect-all');
        const exportPdfBtn = document.getElementById('export-pdf');

        // Event listeners
        fileUpload.addEventListener('change', handleFileUpload);
        selectAllBtn.addEventListener('click', selectAll);
        deselectAllBtn.addEventListener('click', deselectAll);
        exportPdfBtn.addEventListener('click', exportToPDF);

        // File upload handler
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    jsonData = JSON.parse(e.target.result);
                    renderDashboard(jsonData);
                    errorMessage.style.display = 'none';
                } catch (error) {
                    showError('Invalid JSON file: ' + error.message);
                }
            };
            reader.onerror = function() {
                showError('Error reading file');
            };
            reader.readAsText(file);
        }

        // Error display
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            dashboard.innerHTML = '';
        }

        // Dashboard rendering
        function renderDashboard(data) {
            dashboard.innerHTML = '';
            chartInstances = [];

            // Render each category
            for (const [categoryName, categoryData] of Object.entries(data)) {
                renderCategory(categoryName, categoryData);
            }
        }

        // Render a category
        function renderCategory(categoryName, categoryData) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category';
            categoryDiv.id = `category-${categoryName}`;

            const headerDiv = document.createElement('div');
            headerDiv.className = 'category-header';
            headerDiv.textContent = categoryName;
            categoryDiv.appendChild(headerDiv);

            // Render each variable in the category
            categoryData.variables.forEach(variable => {
                renderVariable(categoryDiv, variable, categoryName);
            });

            dashboard.appendChild(categoryDiv);
        }

        // Render a variable
        function renderVariable(categoryDiv, variable, categoryName) {
            const variableDiv = document.createElement('div');
            variableDiv.className = 'variable';
            variableDiv.id = `variable-${categoryName}-${variable.name.trim().replace(/\s+/g, '-')}`;

            // Variable header
            const headerDiv = document.createElement('div');
            headerDiv.className = 'variable-header';

            const titleDiv = document.createElement('div');
            titleDiv.className = 'variable-title';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'variable-name';
            nameSpan.textContent = variable.name.trim();

            const unitSpan = document.createElement('span');
            unitSpan.className = 'unit';
            unitSpan.textContent = variable.unit ? `(${variable.unit})` : '';

            titleDiv.appendChild(nameSpan);
            titleDiv.appendChild(unitSpan);

            // Tags
            if (variable.tags && variable.tags.length > 0) {
                const tagsDiv = document.createElement('div');
                tagsDiv.className = 'tags';
                variable.tags.forEach(tag => {
                    const tagSpan = document.createElement('span');
                    tagSpan.className = 'tag';
                    tagSpan.textContent = tag;
                    tagsDiv.appendChild(tagSpan);
                });
                titleDiv.appendChild(tagsDiv);
            }

            headerDiv.appendChild(titleDiv);

            // Checkbox
            const checkboxDiv = document.createElement('div');
            checkboxDiv.className = 'checkbox-container';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `checkbox-${categoryName}-${variable.name.trim().replace(/\s+/g, '-')}`;
            checkbox.checked = true;

            const checkboxLabel = document.createElement('label');
            checkboxLabel.setAttribute('for', checkbox.id);
            checkboxLabel.textContent = 'Include in PDF';

            checkboxDiv.appendChild(checkbox);
            checkboxDiv.appendChild(checkboxLabel);
            headerDiv.appendChild(checkboxDiv);

            variableDiv.appendChild(headerDiv);

            // Data table
            const table = createDataTable(variable.data, variable.unit);
            variableDiv.appendChild(table);

            // Subvariables
            if (variable.subVariables && variable.subVariables.length > 0) {
                variable.subVariables.forEach(subVariable => {
                    renderSubVariable(variableDiv, subVariable, categoryName, variable.name);
                });
            }

            // Notes
            if (variable.notes && variable.notes.trim() !== '') {
                const notesDiv = document.createElement('div');
                notesDiv.className = 'notes';
                notesDiv.textContent = variable.notes.trim();
                variableDiv.appendChild(notesDiv);
            }

            // Chart
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            const chartId = `chart-${categoryName}-${variable.name.trim().replace(/\s+/g, '-')}`;
            chartContainer.id = chartId;
            variableDiv.appendChild(chartContainer);

            categoryDiv.appendChild(variableDiv);

            // Render chart after DOM is updated
            setTimeout(() => {
                renderChart(chartId, variable, categoryName);
            }, 100);
        }

        // Render a subvariable
        function renderSubVariable(parentDiv, subVariable, categoryName, parentVariableName) {
            const subVariableDiv = document.createElement('div');
            subVariableDiv.className = 'subvariable';

            // Subvariable header
            const headerDiv = document.createElement('div');
            headerDiv.className = 'subvariable-header';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'subvariable-name';
            nameSpan.textContent = subVariable.name;

            headerDiv.appendChild(nameSpan);

            // Checkbox
            const checkboxDiv = document.createElement('div');
            checkboxDiv.className = 'checkbox-container';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `checkbox-${categoryName}-${parentVariableName.trim().replace(/\s+/g, '-')}-${subVariable.name.trim().replace(/\s+/g, '-')}`;
            checkbox.checked = true;

            const checkboxLabel = document.createElement('label');
            checkboxLabel.setAttribute('for', checkbox.id);
            checkboxLabel.textContent = 'Include in PDF';

            checkboxDiv.appendChild(checkbox);
            checkboxDiv.appendChild(checkboxLabel);
            headerDiv.appendChild(checkboxDiv);

            subVariableDiv.appendChild(headerDiv);

            // Data table
            const table = createDataTable(subVariable.data, '');
            subVariableDiv.appendChild(table);

            parentDiv.appendChild(subVariableDiv);
        }

        // Create data table with deltas
        function createDataTable(data, unit) {
            const weeks = Object.keys(data);
            const values = Object.values(data);
            const deltas = calculateDeltas(values);

            const table = document.createElement('table');
            
            // Header row
            const headerRow = document.createElement('tr');
            const weekHeader = document.createElement('th');
            weekHeader.textContent = 'Week';
            headerRow.appendChild(weekHeader);
            
            weeks.forEach(week => {
                const th = document.createElement('th');
                th.textContent = week;
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);
            
            // Value row
            const valueRow = document.createElement('tr');
            const valueLabel = document.createElement('td');
            valueLabel.textContent = 'Value';
            valueRow.appendChild(valueLabel);
            
            values.forEach(value => {
                const td = document.createElement('td');
                td.textContent = value !== null ? value + (unit ? ` ${unit}` : '') : '–';
                valueRow.appendChild(td);
            });
            table.appendChild(valueRow);
            
            // Delta row
            const deltaRow = document.createElement('tr');
            const deltaLabel = document.createElement('td');
            deltaLabel.textContent = 'Delta';
            deltaRow.appendChild(deltaLabel);
            
            deltas.forEach(delta => {
                const td = document.createElement('td');
                if (delta !== null) {
                    td.textContent = (delta > 0 ? '+' : '') + delta;
                    td.className = delta >= 0 ? 'delta-positive' : 'delta-negative';
                } else {
                    td.textContent = '–';
                }
                deltaRow.appendChild(td);
            });
            table.appendChild(deltaRow);
            
            return table;
        }

        // Calculate deltas between consecutive non-null values
        function calculateDeltas(values) {
            const deltas = [];
            let prevValue = null;
            
            for (let i = 0; i < values.length; i++) {
                const currentValue = values[i];
                
                if (currentValue === null) {
                    deltas.push(null);
                } else if (prevValue === null) {
                    deltas.push(null);
                    prevValue = currentValue;
                } else {
                    deltas.push(currentValue - prevValue);
                    prevValue = currentValue;
                }
            }
            
            return deltas;
        }

        // Render chart for a variable
        function renderChart(chartId, variable, categoryName) {
            const ctx = document.getElementById(chartId).getContext('2d');
            const weeks = Object.keys(variable.data);
            
            // Prepare datasets
            const datasets = [];
            
            // Main variable dataset
            const mainData = Object.values(variable.data);
            datasets.push({
                label: variable.name.trim(),
                data: mainData,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.1,
                fill: true
            });
            
            // Subvariable datasets
            if (variable.subVariables && variable.subVariables.length > 0) {
                const colors = ['#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c'];
                
                variable.subVariables.forEach((subVar, index) => {
                    datasets.push({
                        label: subVar.name,
                        data: Object.values(subVar.data),
                        borderColor: colors[index % colors.length],
                        backgroundColor: 'transparent',
                        tension: 0.1
                    });
                });
            }
            
            // Create chart
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${variable.name.trim()} - ${categoryName}`
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
            
            chartInstances.push(chart);
        }

        // Select all checkboxes
        function selectAll() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        // Deselect all checkboxes
        function deselectAll() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // Export to PDF
        async function exportToPDF() {
            if (!jsonData) {
                showError('No data loaded. Please upload a JSON file first.');
                return;
            }

            // Create a temporary container for PDF content
            const pdfContainer = document.createElement('div');
            pdfContainer.id = 'pdf-container';
            pdfContainer.style.width = '1123px'; // A4 landscape width in pixels
            pdfContainer.style.padding = '20px';
            pdfContainer.style.backgroundColor = 'white';
            
            // Add title
            const title = document.createElement('h1');
            title.textContent = 'Analytics Report';
            title.style.textAlign = 'center';
            title.style.marginBottom = '30px';
            pdfContainer.appendChild(title);
            
            // Process each category
            for (const [categoryName, categoryData] of Object.entries(jsonData)) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                categoryDiv.style.marginBottom = '30px';
                categoryDiv.style.breakInside = 'avoid';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'category-header';
                headerDiv.textContent = categoryName;
                categoryDiv.appendChild(headerDiv);
                
                // Process each variable in the category
                categoryData.variables.forEach(variable => {
                    const variableCheckboxId = `checkbox-${categoryName}-${variable.name.trim().replace(/\s+/g, '-')}`;
                    const variableCheckbox = document.getElementById(variableCheckboxId);
                    
                    if (variableCheckbox && variableCheckbox.checked) {
                        const variableDiv = document.createElement('div');
                        variableDiv.className = 'variable';
                        
                        // Variable header
                        const variableHeader = document.createElement('div');
                        variableHeader.className = 'variable-header';
                        
                        const titleDiv = document.createElement('div');
                        titleDiv.className = 'variable-title';
                        
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'variable-name';
                        nameSpan.textContent = variable.name.trim();
                        
                        const unitSpan = document.createElement('span');
                        unitSpan.className = 'unit';
                        unitSpan.textContent = variable.unit ? `(${variable.unit})` : '';
                        
                        titleDiv.appendChild(nameSpan);
                        titleDiv.appendChild(unitSpan);
                        
                        // Tags
                        if (variable.tags && variable.tags.length > 0) {
                            const tagsDiv = document.createElement('div');
                            tagsDiv.className = 'tags';
                            variable.tags.forEach(tag => {
                                const tagSpan = document.createElement('span');
                                tagSpan.className = 'tag';
                                tagSpan.textContent = tag;
                                tagsDiv.appendChild(tagSpan);
                            });
                            titleDiv.appendChild(tagsDiv);
                        }
                        
                        variableHeader.appendChild(titleDiv);
                        variableDiv.appendChild(variableHeader);
                        
                        // Data table
                        const table = createDataTable(variable.data, variable.unit);
                        variableDiv.appendChild(table);
                        
                        // Subvariables
                        if (variable.subVariables && variable.subVariables.length > 0) {
                            variable.subVariables.forEach(subVariable => {
                                const subVariableCheckboxId = `checkbox-${categoryName}-${variable.name.trim().replace(/\s+/g, '-')}-${subVariable.name.trim().replace(/\s+/g, '-')}`;
                                const subVariableCheckbox = document.getElementById(subVariableCheckboxId);
                                
                                if (subVariableCheckbox && subVariableCheckbox.checked) {
                                    const subVariableDiv = document.createElement('div');
                                    subVariableDiv.className = 'subvariable';
                                    
                                    const subHeaderDiv = document.createElement('div');
                                    subHeaderDiv.className = 'subvariable-header';
                                    
                                    const subNameSpan = document.createElement('span');
                                    subNameSpan.className = 'subvariable-name';
                                    subNameSpan.textContent = subVariable.name;
                                    
                                    subHeaderDiv.appendChild(subNameSpan);
                                    subVariableDiv.appendChild(subHeaderDiv);
                                    
                                    const subTable = createDataTable(subVariable.data, '');
                                    subVariableDiv.appendChild(subTable);
                                    
                                    variableDiv.appendChild(subVariableDiv);
                                }
                            });
                        }
                        
                        // Notes
                        if (variable.notes && variable.notes.trim() !== '') {
                            const notesDiv = document.createElement('div');
                            notesDiv.className = 'notes';
                            notesDiv.textContent = variable.notes.trim();
                            variableDiv.appendChild(notesDiv);
                        }
                        
                        // Chart
                        const chartContainer = document.createElement('div');
                        chartContainer.className = 'chart-container';
                        chartContainer.style.height = '200px';
                        
                        // Create a canvas for the chart
                        const canvas = document.createElement('canvas');
                        chartContainer.appendChild(canvas);
                        variableDiv.appendChild(chartContainer);
                        
                        categoryDiv.appendChild(variableDiv);
                        
                        // Render chart to the canvas
                        setTimeout(() => {
                            renderChartToCanvas(canvas, variable, categoryName);
                        }, 100);
                    }
                });
                
                if (categoryDiv.children.length > 1) { // More than just the header
                    pdfContainer.appendChild(categoryDiv);
                }
            }
            
            // Add to document temporarily
            document.body.appendChild(pdfContainer);
            
            try {
                // Generate PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('landscape', 'px', 'a4');
                
                // Use html2canvas to capture the content
                const canvas = await html2canvas(pdfContainer, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    logging: false
                });
                
                const imgData = canvas.toDataURL('image/png');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                // Calculate image dimensions to fit the page
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                const imgX = (pdfWidth - imgWidth * ratio) / 2;
                const imgY = 30;
                
                pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
                pdf.save('analytics-report.pdf');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showError('Error generating PDF: ' + error.message);
            } finally {
                // Clean up
                document.body.removeChild(pdfContainer);
            }
        }

        // Render chart to a specific canvas (for PDF)
        function renderChartToCanvas(canvas, variable, categoryName) {
            const ctx = canvas.getContext('2d');
            const weeks = Object.keys(variable.data);
            
            // Prepare datasets
            const datasets = [];
            
            // Main variable dataset
            const mainData = Object.values(variable.data);
            datasets.push({
                label: variable.name.trim(),
                data: mainData,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.1,
                fill: true
            });
            
            // Subvariable datasets (only those selected)
            if (variable.subVariables && variable.subVariables.length > 0) {
                const colors = ['#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c'];
                
                variable.subVariables.forEach((subVar, index) => {
                    const subVariableCheckboxId = `checkbox-${categoryName}-${variable.name.trim().replace(/\s+/g, '-')}-${subVar.name.trim().replace(/\s+/g, '-')}`;
                    const subVariableCheckbox = document.getElementById(subVariableCheckboxId);
                    
                    if (subVariableCheckbox && subVariableCheckbox.checked) {
                        datasets.push({
                            label: subVar.name,
                            data: Object.values(subVar.data),
                            borderColor: colors[index % colors.length],
                            backgroundColor: 'transparent',
                            tension: 0.1
                        });
                    }
                });
            }
            
            // Create chart
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${variable.name.trim()} - ${categoryName}`
                        },
                        legend: {
                            display: datasets.length > 1
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
