<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --accent-color: #ff6b6b;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background-color: #f5f7fa;
            padding: var(--spacing-md);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: var(--spacing-md);
        }

        .upload-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 400px;
        }

        .file-input {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--light-color);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input:hover {
            border-color: var(--primary-color);
            background-color: #e9ecef;
        }

        .file-input input {
            display: none;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .checkbox-controls {
            display: flex;
            gap: var(--spacing-md);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background-color: var(--secondary-color);
        }

        .btn-export {
            background-color: var(--accent-color);
        }

        .btn-export:hover {
            background-color: #ff5252;
        }

        .error-message {
            color: var(--danger-color);
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            display: none;
        }

        .dashboard {
            display: grid;
            gap: var(--spacing-lg);
        }

        .category {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .category-header {
            background-color: var(--primary-color);
            color: white;
            padding: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .category-checkbox {
            transform: scale(1.2);
        }

        .variables-container {
            padding: var(--spacing-md);
        }

        .variable {
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--light-color);
        }

        .variable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .variable-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .variable-meta {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .tags {
            display: flex;
            gap: var(--spacing-sm);
        }

        .tag {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .unit {
            font-style: italic;
            color: #6c757d;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--spacing-md);
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .data-table th {
            background-color: #e9ecef;
            font-weight: 600;
        }

        .delta-positive {
            color: var(--success-color);
            font-weight: 600;
        }

        .delta-negative {
            color: var(--danger-color);
            font-weight: 600;
        }

        .delta-neutral {
            color: #6c757d;
        }

        .subvariables {
            margin-top: var(--spacing-md);
            padding-left: var(--spacing-md);
        }

        .subvariable {
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: white;
        }

        .subvariable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .subvariable-title {
            font-weight: 600;
            color: var(--dark-color);
        }

        .chart-container {
            margin-top: var(--spacing-md);
            height: 300px;
            position: relative;
        }

        .notes {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: var(--border-radius);
            font-style: italic;
        }

        .notes-title {
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: #856404;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: var(--spacing-md);
            }
            
            .variable-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-sm);
            }
            
            .variable-meta {
                flex-wrap: wrap;
            }
        }

        @media print {
            body {
                background-color: white;
                padding: 0;
            }
            
            .upload-section,
            .controls,
            .error-message {
                display: none;
            }
            
            .category {
                box-shadow: none;
                border: 1px solid var(--border-color);
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Analytics Dashboard</h1>
            <div class="upload-section">
                <div class="file-input-wrapper">
                    <div class="file-input" id="fileInputLabel">
                        <span>Click to upload JSON file</span>
                        <input type="file" id="fileInput" accept="application/json">
                    </div>
                </div>
            </div>
        </header>

        <div class="error-message" id="errorMessage"></div>

        <div class="controls">
            <div class="checkbox-controls">
                <button class="btn" id="selectAllBtn">Select All</button>
                <button class="btn" id="deselectAllBtn">Deselect All</button>
            </div>
            <button class="btn btn-export" id="exportPdfBtn">Export to PDF</button>
        </div>

        <div class="dashboard" id="dashboard"></div>
    </div>

    <script>
        // Global variables
        let chartInstances = [];
        let jsonData = null;

        // DOM elements
        const fileInput = document.getElementById('fileInput');
        const fileInputLabel = document.getElementById('fileInputLabel');
        const errorMessage = document.getElementById('errorMessage');
        const dashboard = document.getElementById('dashboard');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');
        const exportPdfBtn = document.getElementById('exportPdfBtn');

        // Event listeners
        fileInput.addEventListener('change', handleFileUpload);
        fileInputLabel.addEventListener('click', () => fileInput.click());
        selectAllBtn.addEventListener('click', selectAllCheckboxes);
        deselectAllBtn.addEventListener('click', deselectAllCheckboxes);
        exportPdfBtn.addEventListener('click', exportToPdf);

        // File upload handler
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    jsonData = JSON.parse(e.target.result);
                    errorMessage.style.display = 'none';
                    renderDashboard();
                    fileInputLabel.textContent = file.name;
                } catch (error) {
                    showError('Invalid JSON file. Please check the file format.');
                    console.error('Error parsing JSON:', error);
                }
            };
            reader.onerror = function() {
                showError('Error reading file. Please try again.');
            };
            reader.readAsText(file);
        }

        // Error display function
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            dashboard.innerHTML = '';
            jsonData = null;
        }

        // Render the entire dashboard
        function renderDashboard() {
            dashboard.innerHTML = '';
            chartInstances = [];

            if (!jsonData) return;

            // Create containers for each category
            Object.keys(jsonData).forEach(categoryName => {
                const category = jsonData[categoryName];
                const categoryElement = createCategoryElement(categoryName, category);
                dashboard.appendChild(categoryElement);
            });
        }

        // Create a category element
        function createCategoryElement(categoryName, category) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category';
            categoryDiv.id = `category-${categoryName}`;

            // Category header
            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'category-header';
            
            const categoryTitle = document.createElement('h2');
            categoryTitle.className = 'category-title';
            categoryTitle.textContent = categoryName;
            
            const categoryCheckbox = document.createElement('input');
            categoryCheckbox.type = 'checkbox';
            categoryCheckbox.className = 'category-checkbox';
            categoryCheckbox.checked = true;
            categoryCheckbox.addEventListener('change', function() {
                const variablesContainer = categoryDiv.querySelector('.variables-container');
                const checkboxes = variablesContainer.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
            
            categoryHeader.appendChild(categoryTitle);
            categoryHeader.appendChild(categoryCheckbox);
            categoryDiv.appendChild(categoryHeader);

            // Variables container
            const variablesContainer = document.createElement('div');
            variablesContainer.className = 'variables-container';

            // Create elements for each variable
            category.variables.forEach(variable => {
                const variableElement = createVariableElement(variable);
                variablesContainer.appendChild(variableElement);
            });

            categoryDiv.appendChild(variablesContainer);
            return categoryDiv;
        }

        // Create a variable element
        function createVariableElement(variable) {
            const variableDiv = document.createElement('div');
            variableDiv.className = 'variable';

            // Variable header
            const variableHeader = document.createElement('div');
            variableHeader.className = 'variable-header';
            
            const variableTitle = document.createElement('h3');
            variableTitle.className = 'variable-title';
            variableTitle.textContent = variable.name.trim();
            
            const variableMeta = document.createElement('div');
            variableMeta.className = 'variable-meta';
            
            // Tags
            if (variable.tags && variable.tags.length > 0) {
                const tagsContainer = document.createElement('div');
                tagsContainer.className = 'tags';
                
                variable.tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag';
                    tagElement.textContent = tag;
                    tagsContainer.appendChild(tagElement);
                });
                
                variableMeta.appendChild(tagsContainer);
            }
            
            // Unit
            if (variable.unit) {
                const unitElement = document.createElement('span');
                unitElement.className = 'unit';
                unitElement.textContent = variable.unit;
                variableMeta.appendChild(unitElement);
            }
            
            // Checkbox
            const variableCheckbox = document.createElement('input');
            variableCheckbox.type = 'checkbox';
            variableCheckbox.className = 'variable-checkbox';
            variableCheckbox.checked = true;
            variableCheckbox.dataset.type = 'variable';
            variableMeta.appendChild(variableCheckbox);
            
            variableHeader.appendChild(variableTitle);
            variableHeader.appendChild(variableMeta);
            variableDiv.appendChild(variableHeader);

            // Data table
            const tableElement = createDataTable(variable.data, variable.unit);
            variableDiv.appendChild(tableElement);

            // Subvariables
            if (variable.subVariables && variable.subVariables.length > 0) {
                const subvariablesContainer = document.createElement('div');
                subvariablesContainer.className = 'subvariables';
                
                variable.subVariables.forEach(subVariable => {
                    const subVariableElement = createSubVariableElement(subVariable, variable.unit);
                    subvariablesContainer.appendChild(subVariableElement);
                });
                
                variableDiv.appendChild(subvariablesContainer);
            }

            // Chart
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            const canvas = document.createElement('canvas');
            chartContainer.appendChild(canvas);
            variableDiv.appendChild(chartContainer);

            // Notes
            if (variable.notes && variable.notes.trim() !== '') {
                const notesElement = document.createElement('div');
                notesElement.className = 'notes';
                
                const notesTitle = document.createElement('div');
                notesTitle.className = 'notes-title';
                notesTitle.textContent = 'Notes:';
                
                const notesContent = document.createElement('div');
                notesContent.textContent = variable.notes.trim();
                
                notesElement.appendChild(notesTitle);
                notesElement.appendChild(notesContent);
                variableDiv.appendChild(notesElement);
            }

            // Render chart after the element is added to DOM
            setTimeout(() => {
                renderChart(canvas, variable);
            }, 100);

            return variableDiv;
        }

        // Create a subvariable element
        function createSubVariableElement(subVariable, unit) {
            const subVariableDiv = document.createElement('div');
            subVariableDiv.className = 'subvariable';

            // Subvariable header
            const subVariableHeader = document.createElement('div');
            subVariableHeader.className = 'subvariable-header';
            
            const subVariableTitle = document.createElement('h4');
            subVariableTitle.className = 'subvariable-title';
            subVariableTitle.textContent = subVariable.name;
            
            const subVariableCheckbox = document.createElement('input');
            subVariableCheckbox.type = 'checkbox';
            subVariableCheckbox.className = 'subvariable-checkbox';
            subVariableCheckbox.checked = true;
            subVariableCheckbox.dataset.type = 'subvariable';
            
            subVariableHeader.appendChild(subVariableTitle);
            subVariableHeader.appendChild(subVariableCheckbox);
            subVariableDiv.appendChild(subVariableHeader);

            // Data table
            const tableElement = createDataTable(subVariable.data, unit);
            subVariableDiv.appendChild(tableElement);

            return subVariableDiv;
        }

        // Create a data table with weeks and deltas
        function createDataTable(data, unit) {
            const table = document.createElement('table');
            table.className = 'data-table';
            
            // Get week labels
            const weeks = Object.keys(data);
            if (weeks.length === 0) return table;
            
            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const weekHeader = document.createElement('th');
            weekHeader.textContent = 'Week';
            headerRow.appendChild(weekHeader);
            
            weeks.forEach(week => {
                const th = document.createElement('th');
                th.textContent = week;
                headerRow.appendChild(th);
            });
            
            const deltaHeader = document.createElement('th');
            deltaHeader.textContent = 'Δ';
            headerRow.appendChild(deltaHeader);
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            const dataRow = document.createElement('tr');
            
            const valueCell = document.createElement('td');
            valueCell.textContent = 'Value';
            valueCell.style.fontWeight = '600';
            dataRow.appendChild(valueCell);
            
            // Calculate deltas
            const deltas = calculateDeltas(data);
            
            // Add data cells
            weeks.forEach(week => {
                const td = document.createElement('td');
                const value = data[week];
                
                if (value === null || value === undefined) {
                    td.textContent = '–';
                } else {
                    td.textContent = unit === '%' ? `${value}%` : value;
                }
                
                dataRow.appendChild(td);
            });
            
            // Add delta cell
            const deltaCell = document.createElement('td');
            deltaCell.textContent = '–';
            dataRow.appendChild(deltaCell);
            
            tbody.appendChild(dataRow);
            
            // Add delta row
            const deltaRow = document.createElement('tr');
            
            const deltaLabelCell = document.createElement('td');
            deltaLabelCell.textContent = 'Change';
            deltaLabelCell.style.fontWeight = '600';
            deltaRow.appendChild(deltaLabelCell);
            
            weeks.forEach(week => {
                const td = document.createElement('td');
                const delta = deltas[week];
                
                if (delta === null || delta === undefined) {
                    td.textContent = '–';
                    td.className = 'delta-neutral';
                } else if (delta > 0) {
                    td.textContent = `+${delta}`;
                    td.className = 'delta-positive';
                } else if (delta < 0) {
                    td.textContent = delta;
                    td.className = 'delta-negative';
                } else {
                    td.textContent = '0';
                    td.className = 'delta-neutral';
                }
                
                deltaRow.appendChild(td);
            });
            
            const emptyDeltaCell = document.createElement('td');
            emptyDeltaCell.textContent = '–';
            deltaRow.appendChild(emptyDeltaCell);
            
            tbody.appendChild(deltaRow);
            table.appendChild(tbody);
            
            return table;
        }

        // Calculate deltas between weeks
        function calculateDeltas(data) {
            const weeks = Object.keys(data);
            const deltas = {};
            let prevValue = null;
            
            weeks.forEach(week => {
                const currentValue = data[week];
                
                if (currentValue === null || currentValue === undefined) {
                    deltas[week] = null;
                } else if (prevValue === null) {
                    deltas[week] = null;
                    prevValue = currentValue;
                } else {
                    deltas[week] = currentValue - prevValue;
                    prevValue = currentValue;
                }
            });
            
            return deltas;
        }

        // Render chart for a variable
        function renderChart(canvas, variable) {
            const weeks = Object.keys(variable.data);
            const datasets = [];
            
            // Add main variable dataset
            const mainData = weeks.map(week => variable.data[week]);
            datasets.push({
                label: variable.name.trim(),
                data: mainData,
                borderColor: '#4a6fa5',
                backgroundColor: 'rgba(74, 111, 165, 0.1)',
                tension: 0.3,
                fill: true
            });
            
            // Add subvariable datasets
            if (variable.subVariables && variable.subVariables.length > 0) {
                const colors = ['#ff6b6b', '#51cf66', '#fcc419', '#ae3ec9', '#20c997'];
                
                variable.subVariables.forEach((subVariable, index) => {
                    const subData = weeks.map(week => subVariable.data[week]);
                    datasets.push({
                        label: subVariable.name,
                        data: subData,
                        borderColor: colors[index % colors.length],
                        backgroundColor: 'transparent',
                        tension: 0.3,
                        borderDash: [5, 5]
                    });
                });
            }
            
            const chart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            chartInstances.push(chart);
        }

        // Select all checkboxes
        function selectAllCheckboxes() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        // Deselect all checkboxes
        function deselectAllCheckboxes() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // Export to PDF
        function exportToPdf() {
            if (!jsonData) {
                showError('No data to export. Please upload a JSON file first.');
                return;
            }

            // Create a temporary container for PDF content
            const pdfContainer = document.createElement('div');
            pdfContainer.style.width = '100%';
            pdfContainer.style.padding = '20px';
            pdfContainer.style.backgroundColor = 'white';
            
            // Add title
            const title = document.createElement('h1');
            title.textContent = 'Analytics Report';
            title.style.textAlign = 'center';
            title.style.marginBottom = '20px';
            title.style.color = '#4a6fa5';
            pdfContainer.appendChild(title);
            
            // Add date
            const date = document.createElement('p');
            date.textContent = `Generated on: ${new Date().toLocaleDateString()}`;
            date.style.textAlign = 'center';
            date.style.marginBottom = '30px';
            date.style.color = '#6c757d';
            pdfContainer.appendChild(date);
            
            // Clone selected categories, variables, and subvariables
            Object.keys(jsonData).forEach(categoryName => {
                const categoryElement = document.getElementById(`category-${categoryName}`);
                if (!categoryElement) return;
                
                const categoryClone = categoryElement.cloneNode(true);
                
                // Remove checkboxes from the clone
                const checkboxes = categoryClone.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => checkbox.remove());
                
                // Remove charts (they will be recreated as images)
                const chartContainers = categoryClone.querySelectorAll('.chart-container');
                chartContainers.forEach(container => {
                    // Replace canvas with image if available
                    const canvas = container.querySelector('canvas');
                    if (canvas && canvas.chart) {
                        const image = new Image();
                        image.src = canvas.toDataURL();
                        image.style.maxWidth = '100%';
                        container.innerHTML = '';
                        container.appendChild(image);
                    }
                });
                
                // Filter out unchecked variables and subvariables
                const variableElements = categoryClone.querySelectorAll('.variable');
                variableElements.forEach(variableElement => {
                    const variableCheckbox = categoryElement.querySelector(`.variable-checkbox[data-type="variable"]`);
                    if (variableCheckbox && !variableCheckbox.checked) {
                        variableElement.remove();
                        return;
                    }
                    
                    // Filter subvariables
                    const subvariableElements = variableElement.querySelectorAll('.subvariable');
                    subvariableElements.forEach(subvariableElement => {
                        const subvariableCheckbox = categoryElement.querySelector(`.subvariable-checkbox[data-type="subvariable"]`);
                        if (subvariableCheckbox && !subvariableCheckbox.checked) {
                            subvariableElement.remove();
                        }
                    });
                });
                
                // Only add category if it has content
                if (categoryClone.querySelector('.variable')) {
                    pdfContainer.appendChild(categoryClone);
                }
            });
            
            // Add to document temporarily
            document.body.appendChild(pdfContainer);
            
            // Generate PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });
            
            // Use html2canvas to capture the content
            html2canvas(pdfContainer, {
                scale: 2,
                useCORS: true,
                logging: false
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                const imgWidth = 297; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                
                // Save the PDF
                pdf.save('analytics-report.pdf');
                
                // Clean up
                document.body.removeChild(pdfContainer);
            });
        }
    </script>
</body>
</html>
